%% This is file `novelette-utilities.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-utilities.sty}%
[2023/01/20 v0.2 LaTeX file (macros used by other sty files)]
%%



%% UTILITY MACROS
%% ----------------------------------------------------------------------------
% These are used by other packages and novelette-*.sty files, during setup.



%% PART I. REDEFINITIONS
% -----------------------------------------------------------------------------
% TeX "helpfully" provides many settings and commands that are inappropriate
% in Novelette. This file unsets, changes, or re-defines things.


%% CLEARPAGE %%%%% maybe \addtocmd\clearpage{...}{}{}
\let\old@clearpage\clearpage\relax
\def\clearpage{%
  \old@clearpage%
  \ifnvt@frontmatter%
    \versohead{}%
    \rectohead{}%
  \fi%
}
%%


%% FRONTMATTER, MAINMATTER, BACKMATTER
% These commands can only be used in document body:
\def\frontmatter{%
  \ifnvt@mainmatter%
    \ClassError{novelette}{No more frontmatter after mainmatter.^^J%
      \nvt@XN}{\nvt@RXN}\nvt@bad%
  \fi%
  \ifnvt@frontmatter\else%
    \pagenumbering{roman}%
    \setcounter{page}{1}%
    \versohead{}%
    \rectohead{}%
  \fi%
  \global\nvt@frontmattertrue%
  \global\nvt@mainmatterfalse%
}
%%
\def\mainmatter{ % Restarts page to 1, arabic numbers; freeze frontpagecount.
  \ifnvt@mainmatter\else%
    \cleartorecto%
    \pagenumbering{arabic}%
    \setcounter{page}{1}%
    \versohead{\allsmcp{\thetitle}}%
    \rectohead{\textit{\theauthor}}%
  \fi%
  \global\nvt@frontmatterfalse%
  \global\nvt@mainmattertrue%
}
%%
\def\backmatter{% Usually not used.
  \cleartorecto%
  \versohead{}%
  \rectohead{}%
}
%%


%% FAKE FRONT MATTER (six-page placeholder)
\def\fakefrontmatterpages{
  \gdef\nvt@usingfakefront{true}
  \thispagestyle{empty} % half-title, page i.
  \null\null\null\null\null\null
  \begin{center}
  {\addfontfeature{Letters=SmallCaps,Scale=1.6}My Book}\par
  \end{center}
  \blankpage % blank, page ii.
  \thispagestyle{empty} % title, page iii.
  \null\null\null\null\null
  \begin{center}
  {\addfontfeature{Letters=SmallCaps,Scale=3}My Book}\par
  \null\null
  \upscale[1.6]{read it and weep\\then read it again}
  \null\null
  \rule{.25\textwidth}{1pt}\par
  \rule{.375\textwidth}{1.5pt}\par
  \rule{.5\textwidth}{2pt}\par
  \rule{.375\textwidth}{1.5pt}\par
  \rule{.25\textwidth}{1pt}\par
  \null\null\null
  {\addfontfeature{Scale=2}Wanna B. Famous}\par
  \vfill
  {\addfontfeature{Scale=1.2}Independently Published}\par
  \end{center}
  \clearpage
  \thispagestyle{empty} % copyright, page iv.
  \null
  \vfil
  \begin{center}
  My Book : read it and weep\\
  then read it again / Wanna B. Famous.\par
  Copyright ©\lnum{\the\year} Myreal Name. All Rights Reserved.\par
  Independently Published by the Copyright Holder,\\
  Mycity, Mynation.\par
  http://www.example.com/wannabfamous/books\par
  This is a work of fiction.\\
  All characters and events are imaginary.\\
  Resemblance to any person, living or dead, is coincidental.\par
  ISBN \lnum{123-45-6789012-3}\par
  \end{center}
  \vfil
  \null
  \clearpage
  \thispagestyle{empty} % visual separator, page v.
  \null
  \vfil
  \begin{center}
  \begingroup
  \addfontfeature{Scale=1.2}
  \textit{Give them Hell}\par
  \endgroup
  \end{center}
  \vfil
  \null
  \blankpage % blank, page vi. Following page is mainmatter, page 1.
}
%%


%% TEXT STYLE (only in frontmatter)
\DeclareDocumentCommand\style{O{}+m}{%
  \ifnvt@frontmatter%
  \begingroup%
  \setlength\parindent{0pt}%
  \hyphenpenalty=20000{}%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{align=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \StrLeft{\nvt@temp@s}{1}[\nvt@temp@s]%
  \def\nvt@alignchoice{:l:c:r:o:i:}%
  \IfSubStr{\nvt@alignchoice}{:\nvt@temp@s:}{}{%
    \ClassWarning{novelette}{Bad value for align in \string\style.^^J%
      Choose: l c r o i^^J%
      Bad value ignored. Default c used.}%
    \def\nvt@temp@s{c}%
  }
  \ifthenelse{\equal{\nvt@temp@s}{r}}{/strut/hfill{}}{}%
  \ifodd\c@page\ifthenelse{\equal{\nvt@temp@s}{o}}{/strut/hfill{}}{}\fi%
  \ifthenelse{\equal{\nvt@temp@s}{c}}{\begin{center}}{}%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{font=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \ifdefined\nvt@fontlist\else\gdef\nvt@fontlist{:mainfont:}\fi%
  %%%%% check if font name was defined: \def\nvt@fontlist{:main:deco: ... user additions.}
  \IfSubStr{\nvt@fontlist}{:\nvt@temp@s:}{%
    \csname\nvt@temp@s\endcsname%
  }{%
    \StrSubstitute{\nvt@fontlist}{:}{ }[\nvt@temp@n]
    \ClassError{novelette}{Bad value for font, in \string\style.^^J%
      Choose: \nvt@temp@n^^J%
      \nvt@XN}{\nvt@RXN}\nvt@bad%
  }%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrSubstitute{\nvt@temp@s}{Scale=}{scale=}[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{scale=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \IfSubStr{\nvt@temp@s}{t}{\nvt@oktrue}{\nvt@okfalse}%
  \StrDel{\nvt@temp@s}{t}[\nvt@temp@s]%
  \IfDecimal{\nvt@temp@s}{%
    \addfontfeature{ScaleAgain=\nvt@temp@s}%
    \ifnvt@ok%
      \sbox0{3456789JÀÁÂÃÄÅÇçjfhlygpqþ}%
      \setlength\nvt@temp@l{\ht0+\dp0}%
      \setlength\baselineskip{1.05\nvt@temp@l}%
    \else%
      \setlength\baselineskip{\nvt@temp@s\nvt@leading}%
    \fi%
  }{%
   \ifthenelse{\equal{\nvt@temp@s}{}}{}{%
      \ClassError{novelette}{Bad value for scale, in \string\style.^^J%
        Must be integer|decimal number. May have suffix t.^^J%
        \nvt@XN}{\nvt@RXN}\nvt@bad%
      }%
  }%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{bold=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \nvt@okfalse%
  \StrLeft{\nvt@temp@s}{1}[\nvt@temp@s]%
  \ifthenelse{\equal{\nvt@temp@s}{}}{\nvt@oktrue}{}%
  \ifthenelse{\equal{\nvt@temp@s}{t}}{\nvt@oktrue\nvt@boldweight}{}%
  \ifthenelse{\equal{\nvt@temp@s}{f}}{\nvt@oktrue}{}%
  \ifnvt@ok\else%
    \ClassWarning{novelette}{Bad value for bold in \string\style.^^J%
      Choose: bold=true bold=false (default false)^^J%
      The bad value was ignored.}%
  \fi%
  #2%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{align=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \ifthenelse{\equal{\nvt@temp@s}{l}}{/hfill/strut}{}%
  \ifodd\c@page\ifthenelse{\equal{\nvt@temp@s}{i}}{/hfill/strut}{}\fi%
  \ifthenelse{\equal{\nvt@temp@s}{c}}{\end{center}}{}%
  \par%
  \endgroup%
  \else%
    \ClassError{novelette}{\string\style\space only allowed in frontmatter^^J%
      or on part separator pages.^^J%
      \nvt@XN}{\nvt@RXN}\nvt@bad%
  \fi%
}
%%


%% INITIALIZE VARIABLES, AND UNGLUE LENGTHS
%% ----------------------------------------------------------------------------
\setlength\hoffset{0pt}
\setlength\voffset{0pt}
\global\deflength\headheight{0pt}
\global\deflength\headsep{0pt}
\global\deflength\footskip{0pt}
\global\deflength\footnotesep{0pt}
\global\deflength\fboxrule{0pt}
\global\deflength\fboxsep{0pt}
\@twocolumnfalse
\@twosidetrue
\setlength\columnsep{12pt} % Not needed, picked something at random.
\setlength\columnseprule{0pt}
\@mparswitchtrue
\setlength\marginparwidth{0pt}
\setlength\marginparsep{0pt}
\setlength\marginparpush{0pt}
\global\@topnum=0
\setlength\abovedisplayskip{0pt}
\setlength\abovedisplayshortskip{0pt}
\setlength\belowdisplayshortskip{0pt}
\setlength\belowdisplayskip{0pt}
\setlength\smallskipamount{0pt}
\setlength\medskipamount{0pt}
\setlength\bigskipamount{0pt}
\setlength\topsep{0pt}
\setlength\partopsep{0pt}
\setlength\parsep{0pt}
\setlength\parskip{0pt}
\setlength\floatsep{0pt}
\setlength\textfloatsep{0pt}
\setlength\dbltextfloatsep{0pt}
\setlength\intextsep{0pt}
\setlength\lineskip{0pt}
\setlength\normallineskip{0pt}
\setlength\lineskiplimit{0pt}
\renewcommand\baselinestretch{1}
\widowpenalty 150
\clubpenalty 150
\@lowpenalty   51
\@medpenalty  151
\@highpenalty 301
\vbadness=99999 % Suppress nuisance warnings.
\setcounter{topnumber}{2}
\renewcommand\topfraction{1} % Was .7
\setcounter{bottomnumber}{1}
\renewcommand\bottomfraction{1} % Was .3
\setcounter{totalnumber}{3}
\renewcommand\textfraction{0} % Was .2
\renewcommand\floatpagefraction{1} % Was .5
\setcounter{dbltopnumber}{2}
\renewcommand\dbltopfraction{1} % Was .7
\renewcommand\dblfloatpagefraction{1} % Was .5
\DeclareOldFontCommand{\rm}{\normalfont\rmfamily}{\normalfont\rmfamily}
\DeclareOldFontCommand{\sf}{\normalfont\sffamily}{\normalfont\sffamily}
\DeclareOldFontCommand{\tt}{\normalfont\ttfamily}{\normalfont\ttfamily}
\DeclareOldFontCommand{\bf}{}{}
\DeclareOldFontCommand{\it}{\normalfont\itshape}{\normalfont\itshape}
\DeclareOldFontCommand{\sl}{\normalfont\slshape}{\normalfont\slshape}
\DeclareOldFontCommand{\sc}{\normalfont\scshape}{\normalfont\scshape}
\LetLtxMacro\nvt@boldweight\bfseries\relax
\def\bfseries{}
\pagestyle{empty}
\pagenumbering{arabic}
\flushbottom
%%


%% DISABLE OR NEUTRALIZE SOME STANDARD LATEX COMMANDS
%% ----------------------------------------------------------------------------
% Novelette disallows these commands, or neutralizes them by simply
% repeating their arguments. In some cases, they request functionality that is
% not implemented in Novelette. In other cases, functionality is part of core,
% but would interfere with the Novelette emphasis on constant line skip.
% You may redefine the commands using your own Preamble code (discouraged).
% Novelette does not allow TeX size commands. If used, most of them  merely
% echo the argument without change.
\long\gdef\part#1{#1}
\long\gdef\chapter#1{#1}
\long\gdef\section#1{#1}
\long\gdef\subsection#1{#1}
\long\gdef\subsubsection#1{#1}
\long\gdef\paragraph#1{#1}
\long\gdef\subparagraph#1{#1}
\long\gdef\appendix#1{#1}
\DeclareDocumentCommand\nvt@nodocommand{O{}+m}{%
  \ClassError{novelette}{Command `#2' cannot be used in Novelette.^^J%
    \@XN}{\@RXN}\nvt@bad
}
% The no-do commands:
\long\gdef\maketitle{\nvt@nodocommand{maketitle}}
\long\gdef\makeindex{\nvt@nodocommand{makeindex}}
\long\gdef\tableofcontents{\nvt@nodocommand{tableofcontents}}
\long\gdef\listoftables{\nvt@nodocommand{listoftables}}
\long\gdef\listoffigures{\nvt@nodocommand{listoffigures}}
\long\gdef\thebibliography{\nvt@nodocommand{thebibliography}}
\long\gdef\theindex{\nvt@nodocommand{theindex}}
\long\gdef\abstract{\nvt@nodocommand{abstract}}
\long\gdef\caption{\nvt@nodocommand{caption}}
\DeclareDocumentEnvironment{tabular}{sO{}+m}{\nvt@nodocommand{tabular}}{}
\DeclareDocumentEnvironment{table}{sO{}}{\nvt@nodocommand{table}}{}
\DeclareDocumentEnvironment{figure}{sO{}}{\nvt@nodocommand{figure}}{}
\DeclareDocumentEnvironment{itemize}{s}{\nvt@nodocommand{itemize}}{}
\DeclareDocumentEnvironment{enumerate}{s}{\nvt@nodocommand{enumerate}}{}
\DeclareDocumentEnvironment{description}{s}{\nvt@nodocommand{description}}{}
\DeclareDocumentEnvironment{labeling}{s}{\nvt@nodocommand{labeling}}{}
%%


%%
\def\nvt@getepoch{% My first lua code!
  \directlua{
    local jack = os.time()
    tex.sprint(jack)
  }%
}
% Code by user `egreg' at tex.stackexchange.com, q. 62010 :
% Puts environment variable #2 into macro #1.
% Example: \getenv[\userhome]{HOME}
\ExplSyntaxOn
\NewDocumentCommand{\getenv}{om}
 {
  \sys_get_shell:nnN { kpsewhich ~ --var-value ~ #2 } { } \l_tmpa_tl
  \tl_trim_spaces:N \l_tmpa_tl
  \IfNoValueTF { #1 }
   {
    \tl_use:N \l_tmpa_tl
   }
   {
    \tl_set_eq:NN #1 \l_tmpa_tl
   }
 }
\ExplSyntaxOff
% End code by egreg.
\getenv[\nvt@invocation]{processedbynovelette}
\edef\nvt@rightnow{\nvt@getepoch}
\IfInteger{\nvt@invocation}{%
  \FPsub{\nvt@temp@n}{\nvt@rightnow}{\nvt@invocation}%
  \FPabs{\nvt@temp@n}{\nvt@temp@n}%
  \FPiflt{\nvt@temp@n}{20}%
    \gdef\nvt@signoffmsg{Processed with lualatex by novelette script.}%
  \else%
    \long\gdef\nvt@signoffmsg{Processed with lualatex.^^J%
%%%%%      You may get better results by processing via novelette script.^^J%
%%%%%      See Novelette documentation for explanation.%
    }%
  \fi%
}{%
    \long\gdef\nvt@signoffmsg{Processed with lualatex.^^J%
%%%%%      You may get better results by processing via novelette script.^^J%
%%%%%      See Novelette documentation for explanation.%
    }%
}
%%


%% CHANGE MODE ON ERROR (not yet fully enabled)
% Detect whether an error was thrown, regardless of its source.
% If thrown, AtEndDocument changes to draft mode.
\directlua{
  local error_seen = false
  local true_cmd = token.create'use_i:nn'
  local false_cmd = token.create'use_ii:nn'
  local id = luatexbase.new_luafunction'iferrorsissued'
  token.set_lua('iferrorsissued', id)
  lua.get_functions_table()[id] = function()
    token.put_next(error_seen and true_cmd or false_cmd)
  end
  luatexbase.add_to_callback('show_error_hook', function()
    error_seen = true
    texio.write('.')
    tex.show_context()
  end, 'track_errors')
}
%%


%% For convenience, code from `article' class.
%% ----------------------------------------------------------------------------
% Environments verse, quotation, and quote are contained in `article' class.
% They are not very useful in `novelette', but are made available because they
% are often mentioned by others.
\newenvironment{verse}{%
  \let\\\@centercr
  \list{}{%
    \itemsep{0pt} %%%%%
    \itemindent -\parindent%
    \listparindent\itemindent
    \rightmargin \leftmargin
    \advance\leftmargin \parindent%
  }%
  \item\relax%
}{%
  \endlist%
}
\newenvironment{quotation}{%
  \list{}{%
    \listparindent \parindent%
    \itemindent \listparindent
    \rightmargin \leftmargin
    \parsep{0pt}%
  }%
  \item\relax%
}{%
  \endlist%
}
\newenvironment{quote}{%
  \list{}{%
    \rightmargin\leftmargin%
  }%
  \item\relax%
}{%
  \endlist%
}
%%


%% Write straight quotes that TeX will not auto-convert to curly quotes:
\gdef\straightquote{{\addfontfeature{Ligatures=ResetAll}'}}
\gdef\straightdblquote{{\addfontfeature{Ligatures=ResetAll}"}}
%%


%% \memo{} does not print or save its argument. May be more than one paragraph.
% Useful when you wish to put a note to yourself in the *.tex document.
% Not the same as % comment, because anything after the braces will print.
\long\gdef\memo#1{\ignorespaces}
%%


%% \stake is like \strut, but does not occupy much vertical space.
\gdef\stake{\rule{0pt}{1pt}}
%%


%% Unicode character. Four hex digits, uppercase A-F, no following space.
%% Examples: c\uni{0061}t -> cat  d\uni{006F}g -> dog
\def\uni#1{\char"#1}
%%


%% BLOCK INDENTS (integer number of \normalindent)
\newenvironment{pushright}[1][1]{%
  \begingroup%
  \IfInteger{#1}{\def\nvt@temp@n{#1}}{%
    \def\nvt@temp@n{1}%
    \ClassWarning{novelette}{Bad option for \string\begin{pushright}.^^J%
      Option must be integer. Default 1 used.}%
  }%
  \setlength\leftskip{\nvt@temp@n\normalindent}%
}{\endgroup}
%%
\newenvironment{pushleft}[1][1]{%
  \begingroup%
  \IfInteger{#1}{\def\nvt@temp@n{#1}}{%
    \def\nvt@temp@n{1}%
    \ClassWarning{novelette}{Bad option for \string\begin{pushleft}.^^J%
      Option must be integer. Default 1 used.}%
  }%
  \setlength\rightskip{\nvt@temp@n\normalindent}%
}{\endgroup}
%%
\newenvironment{pushcenter}[1][1]{%
  \begingroup%
  \IfInteger{#1}{\def\nvt@temp@n{#1}}{%
    \def\nvt@temp@n{1}%
    \ClassWarning{novelette}{Bad option for \string\begin{pushcenter}.^^J%
      Option must be integer. Default 1 used.}%
  }%
  \setlength\leftskip{\nvt@temp@n\normalindent}%
  \setlength\rightskip{\nvt@temp@n\normalindent}%
}{\endgroup}
%%


%% TODO: limit to display pages %%%%%
\DeclareDocumentCommand\upscale{O{1}+m}{%
  \IfDecimal{#1}{}{%
    \ClassError{novelette}{Bad optional argument to \string\upscale.^^J%
      Must be integer|decimal number.^^J%
      \@XN}{\@RXN}\nvt@bad%
  }%
  \begingroup%
  \addfontfeature{ScaleAgain=#1}%
  \setlength\baselineskip{#1\nvt@leading}#2\par%
  \endgroup%
}
%%


\ExplSyntaxOn
%% \smcp{} and \textsc{} lowercase to small caps (Open Type):
\DeclareDocumentCommand\smcp{+m}{% lowercase to small caps
  {\addfontfeature{Letters=SmallCaps}#1}%
}
%% \capsmcp{} uppercase to small caps (OpenType c2sc):
\DeclareDocumentCommand\capsmcp{+m}{% uppercase to small caps
  \fontspec_if_feature:nTF{c2sc}{%
    {\addfontfeature{Letters=UppercaseSmallCaps}#1}%
  }{%
    \fontspec_if_feature:nTF{smcp}{%
      {\addfontfeature{Letters=SmallCaps}\MakeLowercase{#1}}%
    }{%
      #1%
    }%
  }%
}
%%
\DeclareDocumentCommand\allsmcp{+m}{% uppercase+lowercase to small caps
  \fontspec_if_feature:nTF{c2sc}{%
    {\addfontfeature{Letters=UppercaseSmallCaps,Letters=SmallCaps}#1}%
  }{%
    \fontspec_if_feature:nTF{smcp}{%
      {\addfontfeature{Letters=SmallCaps}\MakeLowercase{#1}}%
    }{%
      #1%
    }%
  }%
}
\let\textsc\smcp\relax % unified
\let\oldscshape\scshape\relax % unified
\let\scshape\smcp\relax % unified
\ExplSyntaxOff
%%


%% \lnum for lining numbers.
\gdef\lnum#1{{\addfontfeature{Numbers=ResetAll,%
  Numbers=Lining,RawFeature={+case}}#1}}
%%


%% \init[kern]{Letter}{phrase} for optional styling first line of a chapter.
\DeclareDocumentCommand\init{O{0}mm}{%
  \noindent\smash{\addfontfeature{ScaleAgain=1.33}#2}%
  \IfDecimal{#1}{\kern#1em}{%
    \ClassWarning{novelette}{Bad kern value in \string\init, page \thepage.^^J%
      This kern does not use units, just the number (units will be em).}%
  }%
  \smcp{#3}%
}
%%


%% Fake medium caps, if smcp available:
\DeclareDocumentCommand\medcap{m}{%
  {\addfontfeature{ScaleAgain=1.18,FakeStretch=0.9}\allsmcp{#1}}%
}
%%


% \cleartorecto works same as \clearpage when next page is recto.
%   If next page would be verso, a blank verso is inserted,
%   so that the following material is recto.
% \cleartoend is used at very end of book.
%   It adds a blank page. If the blank is verso, end of book.
%   But if that blank is recto, it adds a second blank page, end of book.
%   So, the book always ends with a blank verso.
\gdef\cleartorecto{
  \clearpage
  \ifodd\c@page\else
    \thispagestyle{empty}\null\clearpage
  \fi
}
\gdef\cleartoend{
  \ifnvt@cleartoend\else
    \clearpage
    \ifodd\c@page
      \thispagestyle{empty}\null\clearpage
    \fi
    \thispagestyle{empty}\null\clearpage
  \fi
  \global\nvt@cleartoendtrue
}
%%


%%
\def\blankpage{%
  \clearpage%
  \thispagestyle{empty}%
  \null%
  \clearpage%
}
%%


\def\sups#1{%
  {\addfontfeature{Numbers=ResetAll,VerticalPosition=Superior}#1}%
}

\def\subs#1{%
  {\addfontfeature{Numbers=ResetAll,VerticalPosition=Inferior}#1}%
}

\AtBeginDocument{%
  \providecommand\fraction[2]{% Use only with Swainson fonts (metrics).
    \raisebox{-.103em}{\sups{#1}}^^^^2044\raisebox{.168em}{\subs{#2}}%
  }%
}


%%
\endinput
%%
%% End of file `novelette-utilities.sty'.
