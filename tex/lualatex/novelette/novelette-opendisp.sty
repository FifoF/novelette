%% This is file `novelette-opendisp.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-opendisp.sty}%
[2023/01/20 v0.2 LaTeX file (opening pages and display pages)]
%%


%% OPENING PAGES
% Some portions of your book will begin with a reserved area, occupying perhaps
% one-fourth to one-half of the main text height. Main text does not begin
% until after the reserved area. The purpose is to create visual
% white space, so the reader knows this is different than what came before.
% New chapters, and some chapter-like portions, start this way.
%   Novelette uses the `opening' environment. Each opening begins a new page.
% If page design has a header, it will be empty above the opening.
%   Within the opening, material will have its own default alignment,
% rather than the full-textwidth justification of main text. The default
% in frontmatter and backmatter is centered. In mainmatter, it is a setting.
% This can be changed on a local basis.
%   When viewed with class option `shadelines', the background of the opening
% is palegray. The number of lines is set by height. The baseline of the
% topmost opening line is set by top. Note that the height and top are not
% enforced; they are only provided for visualization.
%   In Preamble, setting \openings{top=T,height=H,align=A} Integer T, H.
% A is one of center, left, right, outside, inside.
%   Note that the setting is `openings' (plural) but the individual page
% environment is 'opening' (singular), which may be locally modified.
%   Within an opening environment, commands \name and \desc provide
% styled text. Ordinary text and images may also be used.
%%


%% OPENINGS STYLE
% Global setting, In Preamble. Local changes: \thisopeningstyle{}.
\def\nvt@opentop{0} % At top. 
\def\nvt@openht{0} % Number of lines shaded, when shadelines.
\newcommand\openings[1]{
  \nvt@oktrue
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{top=}[\nvt@temp@n]
  \StrBefore{\nvt@temp@n}{,}[\nvt@temp@n]
  \IfInteger{\nvt@temp@n}{
    \FPiflt{\nvt@temp@n}{2}\def\nvt@temp@n{2}\nvt@okfalse\fi
    \FPmul{\nvt@temp@d}{\nvt@lpp}{.33}
    \FPtrunc{\nvt@temp@d}{\nvt@temp@d}{0}
    \FPifgt{\nvt@temp@n}{\nvt@temp@d}\def\nvt@temp@n{\nvt@temp@d}\nvt@okfalse\fi
  }{}
  \ifthenelse{\equal{\nvt@temp@n}{}}{
    \FPmul{\nvt@temp@n}{\nvt@lpp}{.25}
    \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}
  }{}
  \xdef\nvt@opentop{\nvt@temp@n}
  \StrBehind{\nvt@temp@s}{height=}[\nvt@temp@n]
  \StrBefore{\nvt@temp@n}{,}[\nvt@temp@n]
  \IfInteger{\nvt@temp@n}{
    \FPiflt{\nvt@temp@n}{4}\def\nvt@temp@n{4}\nvt@okfalse\fi
    \FPmul{\nvt@temp@d}{\nvt@lpp}{.6}
    \FPtrunc{\nvt@temp@d}{\nvt@temp@d}{0}
    \FPifgt{\nvt@temp@n}{\nvt@temp@d}\def\nvt@temp@n{\nvt@temp@d}\nvt@okfalse\fi
  }{}
  \ifthenelse{\equal{\nvt@temp@n}{}}{
    \FPmul{\nvt@temp@n}{\nvt@lpp}{.5}
    \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}
  }{}
  \xdef\nvt@openht{\nvt@temp@n}
  \StrBehind{\nvt@temp@s}{align=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \gdef\nvt@openalign{oops}
  \ifthenelse{\equal{\nvt@temp@s}{left}}{\gdef\nvt@openalign{left}}{}
  \ifthenelse{\equal{\nvt@temp@s}{right}}{\gdef\nvt@openalign{right}}{}
  \ifthenelse{\equal{\nvt@temp@s}{center}}{\gdef\nvt@openalign{center}}{}
  \ifthenelse{\equal{\nvt@temp@s}{outside}}{\gdef\nvt@openalign{outside}}{}
  \ifthenelse{\equal{\nvt@temp@s}{inside}}{\gdef\nvt@openalign{inside}}{}
  \ifthenelse{\equal{\nvt@temp@s}{}}{\gdef\nvt@openalign{center}}{}
  \ifthenelse{\equal{\nvt@openalign}{oops}}{\gdef\nvt@openalign{left}\nvt@okfalse}{}
  \ifnvt@ok\else\nvt@errBVO\fi
  \xdef\log@openings{\string\openings{top=\nvt@opentop,height=\nvt@openht,%
    alignment=\nvt@openalign}}
}
\@onlypreamble\openings
%%


%%
\def\nvt@process@openings{ % AtEndPreamle.
  \ifthenelse{\equal{\nvt@openht}{0}}{
    \openings{} % Defaults.
  }{}
}
%%


%% OPENING ENVIRONMENT
\newenvironment{opening}{%
  \clearpage%
  \ifnvt@header%
    \ifnvt@footer%
      \thispagestyle{footer}% %%%%%
    \else%
      \thispagestyle{empty}%
    \fi%
  \fi%
  \suppressfloats[t]% Ensures that a floated image does not go above opening.
  \suppressfloats[b]% Or beneath.
  \begingroup%
  \nvt@zmarktrue%
  \nvt@inopeningtrue%
  \setlength\parindent{0pt}% Just within this environment.
  \ifthenelse{\equal{\nvt@openalign}{left}}{}{}%
  \ifthenelse{\equal{\nvt@openalign}{right}}{\raggedleft}{}%
  \ifthenelse{\equal{\nvt@openalign}{center}}{\begin{center}}{}%
  \ifthenelse{\equal{\nvt@openalign}{outside}}{\ifodd\c@page\raggedleft\fi}{}%
  \ifthenelse{\equal{\nvt@openalign}{inside}}{\ifodd\c@page\else\raggedleft\fi}{}%
}{% Close the environment:
  \ifthenelse{\equal{\nvt@openalign}{center}}{\end{center}}{}%
  \setcounter{nvt@fnmnum}{1}% Footnote markers.
  \endgroup%
  \nvt@zmarkfalse%
  \setlength\parindent{\normalindent}% Restored.
}
\AfterEndEnvironment{opening}{%
  \NoIndentAfterThis%
}
%%


\newcommand\name[1]{%
  \ifnvt@inopening%
    \null\par%
    \strut\smash{\nvt@namefont #1}\par%
  \else%
    {#1}%
  \fi%
}
\newcommand\desc[1]{%
  \ifnvt@inopening%
    \null\par%
    \strut\smash{\nvt@descfont #1}\par%
  \else%
    {#1}%
  \fi%
}
%%


%% DISPLAY PAGES
% A "display page" ia a single page with style of its own, unrelated to
% anything else. Examples are Half-Title, Frontispiece, Title Page,
% Copyright Page, Dedication, Epigraph, and perhaps some others.
% Do not confuse a `display' with an `opening'.
%   Each display starts on a new page, and concludes with a new page.
% Note that TeX disregards multiple requests for a new page, unless there
% is something (even an intentional blank page) in between.
%   On a display page, all items are horizontally centered by default.
% There is no paragraph indent. There is a one-line gap between paragraphs.
% Header and footer will be empty. No footnotes are allowed.
%%
\newenvironment{display}{%
  \clearpage%
  \thispagestyle{empty}%
  \begingroup%
  \nvt@indisplaytrue%
  \setlength\parindent{0pt}%
  \setlength\parskip{\nvt@leading}%
  \begin{center}%
}{% End the environment:
  \end{center}%
  \endgroup%
  \vfil%
}
\AfterEndEnvironment{display}{\clearpage}
%%



%%
\endinput
%%
%% End of file `novelette-opendisp.sty'.
