%% This is file `novelette-shades.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-shades.sty}%
[2023/01/20 v0.2 LaTeX file (shadings for margins and lines)]
%%


%% SHADE MARGINS, SHADE LINES
% This file is loaded AtEndPreamble, if mode shade or align.
%   Shading is written into the background. But it must precede other
% background items (in particular, overfull rules) or it will conceal them.
% The `etoolbox` command \pretocmd does the trick.
%   The \textblock does not occupy all width beteen \nvt@mins and \nvt@mout.
% Thin padding \nvt@spad is at either side of \textblock. Although images must
% be confined to \textblock, text may protrude into \nvt@spad. 
%   When line positions are shaded, the top of the shade is at the baseline.
% The thickness of the shade is \nvt@dscn.


\newcounter{nvt@mline}
\newcommand{\nvt@bghook}{}
\newcommand{\nvt@addbg}{\g@addto@macro\nvt@bghook}
\AddToHook{shipout/background}{\put(0,-\pageheight){\nvt@bghook}}
\IfHookEmptyTF{shipout/background}{\AddToHook{shipout/background}{\relax}}{}


%% SHADE MARGINS. SHADE LINES, OPENING GUIDES
% (1) Fill entire trim area with gray. If using \sheetfeed, does not fill area
% beyond the trimbox. (2) Fill rectangle bounded by margins with light gray.
% (3) Fill main textbox with white. Thin side paddings, and the header/footer
% areas (if used) remain light gray. (4) Fill spine glue strip with dark gray.
% (5) If page has an opening environment, place small guides in side margins.
% (6) If shadelines option, place pale gray lines at each baseline of header,
% main tex, footer. Top of line is text baseline. Line depth is \nvt@dscn.
% (7) In side margins, place guides at \nvt@opentop and \nvt@openht.
\pretocmd\@kernel@before@shipout@background{
  % Fill trim area with gray. If sheetfeed, do not extend gray outside trim:
  \nvt@trim@LL{{\nvt@shadeto{.6}\rule{\nvt@trimw}{\nvt@trimh}}}
  % Fill rectangle, bounded by margins, with light gray:
  \nvt@print@LL{{\nvt@shadeto{.75}\rule{\nvt@trimw-\nvt@mout-\nvt@mins}{\nvt@trimh-\nvt@mtop-\nvt@mbot}}}
  % Fill main textblock white. Side padding, header, footer remain light gray:
  \setlength\nvt@temp@l{0pt}
  \ifnvt@footer\setlength\nvt@temp@l{\nvt@leading+\nvt@footgap\nvt@leading}\fi
  \nvt@print@LL{%
    \hspace{\nvt@spad}{\nvt@shadeto{1}\rule[\nvt@temp@l]{\textwidth}{\textheight+\nvt@dscn}}%
  }
  % If shadelines, do it for main, header, footer:
  \ifnvt@shadelines
    \nvt@shade@main@lines
    \ifnvt@header
      \nvt@print@UL{{\nvt@shadeto{.8}\rule[-\nvt@ascn-\nvt@dscn]{\textwidth+2\nvt@spad}{\nvt@dscn}}}
    \fi%
    \ifnvt@footer
      \nvt@print@LL{{\nvt@shadeto{.8}\rule{\textwidth+2\nvt@spad}{\nvt@dscn}}}
    \fi
  \fi
  \nvt@place@opening@guides
  % Dark gray area for spine glue:
  \setlength\nvt@temp@l{\nvt@trimw-\nvt@spinew}%
  \ifodd\c@page\setlength\nvt@temp@l{0pt}\fi%
  \nvt@trim@LL{\rule{\nvt@temp@l}{0pt}{\nvt@shadeto{.4}\rule{\nvt@spinew}{\nvt@trimh}}}%
}{\typeout{Shading applied.}}{\typeout{Shading failed.}}
%%


%% Main text baselines:
\def\nvt@shade@main@lines{%
  \setcounter{nvt@mline}{0}%
  \loop%
  \nvt@print@UL{\nvt@shadeto{.9}%
    \hspace{\nvt@spad}%
    \setlength\nvt@temp@l{-\value{nvt@mline}\nvt@leading}%
    \ifnvt@header\addtolength\nvt@temp@l{-\nvt@leading-\nvt@headgap\nvt@leading}\fi%
    \rule[\nvt@temp@l-\nvt@ascn-\nvt@dscn]{\textwidth}{\nvt@dscn}%
  }%
  \addtocounter{nvt@mline}{1}%
  \ifnum\value{nvt@mline}<\nvt@lpp%
  \repeat%
}
%%


%% Opening guides.
\def\nvt@place@opening@guides{%
  \FPsub{\nvt@openht}{\nvt@openht}{1}%
  \FPsub{\nvt@opentop}{\nvt@opentop}{1}%
  \nvt@print@UL{{\nvt@shadeto{.8}
    \hspace{-16pt}\rule[-\nvt@dscn-\nvt@ascn-\nvt@leading-\nvt@headgap\nvt@leading-\nvt@opentop\nvt@leading]{12pt}{\nvt@dscn}
  }}%
  \nvt@print@UL{{\nvt@shadeto{.8}
    \hspace{-16pt}\rule[-\nvt@dscn-\nvt@ascn-\nvt@leading-\nvt@headgap\nvt@leading-\nvt@openht\nvt@leading]{12pt}{\nvt@dscn}
  }}%
  \nvt@print@UL{{\nvt@shadeto{.8}
    \hspace{\textwidth+2\nvt@spad+4pt}\rule[-\nvt@dscn-\nvt@ascn-\nvt@leading-\nvt@headgap\nvt@leading-\nvt@opentop\nvt@leading]{12pt}{\nvt@dscn}
  }}%
  \nvt@print@UL{{\nvt@shadeto{.8}
    \hspace{\textwidth+2\nvt@spad+4pt}\rule[-\nvt@dscn-\nvt@ascn-\nvt@leading-\nvt@headgap\nvt@leading-\nvt@openht\nvt@leading]{12pt}{\nvt@dscn}
  }}%
}
%%


%%
\endinput
%%
%% End of file `novelette-shades.sty'.
