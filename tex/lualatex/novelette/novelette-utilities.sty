%% This is file `novelette-utilities.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-utilities.sty}%
[2023/01/20 v0.2 LaTeX file (macros used by other sty files)]
%%



%% UTILITY MACROS
%% ----------------------------------------------------------------------------
% These are used by other packages and novelette-*.sty files, during setup.



%% CLEARPAGE %%%%% maybe \addtocmd\clearpage{...}{}{}
\let\old@clearpage\clearpage\relax
\def\clearpage{%
  \old@clearpage%
  \ifnvt@frontmatter%
    \versohead{}%
    \rectohead{}%
  \fi%
}
%%


%% FRONTMATTER, MAINMATTER, BACKMATTER
% These commands can only be used in document body:
\def\frontmatter{%
  \ifnvt@mainmatter%
    \nvt@error{No more frontmatter after mainmatter.}
  \fi%
  \ifnvt@frontmatter\else%
    \pagenumbering{roman}%
    \setcounter{page}{1}%
    \versohead{}%
    \rectohead{}%
  \fi%
  \global\nvt@frontmattertrue%
  \global\nvt@mainmatterfalse%
}
%%
\def\mainmatter{ % Restarts page to 1, arabic numbers; freeze frontpagecount.
  \ifnvt@mainmatter\else%
    \cleartorecto%
    \pagenumbering{arabic}%
    \setcounter{page}{1}%
    \versohead{\allsmcp{\thetitle}}%
    \rectohead{\textit{\theauthor}}%
  \fi%
  \global\nvt@frontmatterfalse%
  \global\nvt@mainmattertrue%
}
%%
\def\backmatter{% Usually not used.
  \cleartorecto%
  \versohead{}%
  \rectohead{}%
}
%%


%% TEXT STYLE (only in frontmatter, for display pages)
\DeclareDocumentCommand\style{O{}+m}{%
  \ifnvt@frontmatter%
  \begingroup%
  \setlength\parindent{0pt}%
  \hyphenpenalty=20000{}%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{align=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \StrLeft{\nvt@temp@s}{1}[\nvt@temp@s]%
  \def\nvt@alignchoice{:l:c:r:o:i:}%
  \IfSubStr{\nvt@alignchoice}{:\nvt@temp@s:}{}{%
    \ClassWarning{novelette}{Bad value for align in \string\style.^^J%
      Choose: l c r o i^^J%
      Bad value ignored. Default c used.}%
    \def\nvt@temp@s{c}%
  }
  \ifthenelse{\equal{\nvt@temp@s}{r}}{/strut/hfill{}}{}%
  \ifodd\c@page\ifthenelse{\equal{\nvt@temp@s}{o}}{/strut/hfill{}}{}\fi%
  \ifthenelse{\equal{\nvt@temp@s}{c}}{\begin{center}}{}%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{font=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \ifdefined\nvt@fontlist\else\gdef\nvt@fontlist{:mainfont:}\fi%
  %%%%% check if font name was defined: \def\nvt@fontlist{:main:deco: ... user additions.}
  \IfSubStr{\nvt@fontlist}{:\nvt@temp@s:}{%
    \csname\nvt@temp@s\endcsname%
  }{%
    \StrSubstitute{\nvt@fontlist}{:}{ }[\nvt@temp@n]
    \nvt@error{Bad value for font, in \string\style.^^J%
      Choose: \nvt@temp@n}
  }%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrSubstitute{\nvt@temp@s}{Scale=}{scale=}[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{scale=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \IfSubStr{\nvt@temp@s}{t}{\nvt@oktrue}{\nvt@okfalse}%
  \StrDel{\nvt@temp@s}{t}[\nvt@temp@s]%
  \IfDecimal{\nvt@temp@s}{%
    \addfontfeature{ScaleAgain=\nvt@temp@s}%
    \ifnvt@ok%
      \sbox0{3456789JÀÁÂÃÄÅÇçjfhlygpqþ}%
      \setlength\nvt@temp@l{\ht0+\dp0}%
      \setlength\baselineskip{1.05\nvt@temp@l}%
    \else%
      \setlength\baselineskip{\nvt@temp@s\nvt@leading}%
    \fi%
  }{%
   \ifthenelse{\equal{\nvt@temp@s}{}}{}{%
      \nvt@error{Bad value for scale, in \string\style.^^J%
        Must be integer|decimal number. May have suffix t (tight).}%
      }%
  }%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{bold=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \nvt@okfalse%
  \StrLeft{\nvt@temp@s}{1}[\nvt@temp@s]%
  \ifthenelse{\equal{\nvt@temp@s}{}}{\nvt@oktrue}{}%
  \ifthenelse{\equal{\nvt@temp@s}{t}}{\nvt@oktrue\nvt@boldweight}{}%
  \ifthenelse{\equal{\nvt@temp@s}{f}}{\nvt@oktrue}{}%
  \ifnvt@ok\else%
    \ClassWarning{novelette}{Bad value for bold in \string\style.^^J%
      Choose: bold=true bold=false (default false)^^J%
      The bad value was ignored.}%
  \fi%
  #2%
  \StrDel{#1,}{ }[\nvt@temp@s]%
  \StrBehind{\nvt@temp@s}{align=}[\nvt@temp@s]%
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]%
  \ifthenelse{\equal{\nvt@temp@s}{l}}{/hfill/strut}{}%
  \ifodd\c@page\ifthenelse{\equal{\nvt@temp@s}{i}}{/hfill/strut}{}\fi%
  \ifthenelse{\equal{\nvt@temp@s}{c}}{\end{center}}{}%
  \par%
  \endgroup%
  \else%
    \nvt@error{\string\style\space only allowed in frontmatter^^J%
      or on part separator pages.}
  \fi%
}
%%


%%
\def\nvt@getepoch{% My first lua code!
  \directlua{
    local jack = os.time()
    tex.sprint(jack)
  }%
}
% Code by user `egreg' at tex.stackexchange.com, q. 62010 :
% Puts environment variable #2 into macro #1.
% Example: \getenv[\userhome]{HOME}
\ExplSyntaxOn
\NewDocumentCommand{\getenv}{om}
 {
  \sys_get_shell:nnN { kpsewhich ~ --var-value ~ #2 } { } \l_tmpa_tl
  \tl_trim_spaces:N \l_tmpa_tl
  \IfNoValueTF { #1 }
   {
    \tl_use:N \l_tmpa_tl
   }
   {
    \tl_set_eq:NN #1 \l_tmpa_tl
   }
 }
\ExplSyntaxOff
% End code by egreg.
% \getenv[\nvt@invocation]{processedbynovelette} %%%%% Not implemented.
\edef\nvt@rightnow{\nvt@getepoch}
%\IfInteger{\nvt@invocation}{%
%  \FPsub{\nvt@temp@n}{\nvt@rightnow}{\nvt@invocation}%
%  \FPabs{\nvt@temp@n}{\nvt@temp@n}%
%  \FPiflt{\nvt@temp@n}{20}%
%    \gdef\nvt@signoffmsg{Processed with lualatex by novelette script.}%
%  \else%
%    \long\gdef\nvt@signoffmsg{Processed with lualatex.^^J%
%      You may get better results by processing via novelette script.^^J%
%      See Novelette documentation for explanation.%
%    }%
%  \fi%
%}{%
    \long\gdef\nvt@signoffmsg{Processed with lualatex.^^J%
%      You may get better results by processing via novelette script.^^J%
%      See Novelette documentation for explanation.%
    }%
%}
%%


%% CHANGE MODE ON ERROR (not yet fully enabled)
% Detect whether an error was thrown, regardless of its source.
% If thrown, AtEndDocument changes to draft mode.
\directlua{
  local error_seen = false
  local true_cmd = token.create'use_i:nn'
  local false_cmd = token.create'use_ii:nn'
  local id = luatexbase.new_luafunction'iferrorsissued'
  token.set_lua('iferrorsissued', id)
  lua.get_functions_table()[id] = function()
    token.put_next(error_seen and true_cmd or false_cmd)
  end
  luatexbase.add_to_callback('show_error_hook', function()
    error_seen = true
    texio.write('.')
    tex.show_context()
  end, 'track_errors')
}
%%


%% Write straight quotes that TeX will not auto-convert to curly quotes:
\def\straightquote{{\addfontfeature{Ligatures=ResetAll}'}}
\def\straightdblquote{{\addfontfeature{Ligatures=ResetAll}"}}
%%


%% \memo{} does not print or save its argument. May be more than one paragraph.
% Useful when you wish to put a note to yourself in the *.tex document.
% Not the same as % comment. It cannot be used at the end of a text line.
\long\def\memo#1{%
  \ifvmode\else%
    \nvt@error{Command \string\memo\space cannot be used within a paragraph.}%
  \fi%
}
%%


%% \stake does not occupy much vertical space.
\gdef\stake{\rule{0pt}{.02pt}}
%%


%% Unicode character. Four hex digits, uppercase A-F, no following space.
%% Examples: c\uni{0061}t -> cat  d\uni{006F}g -> dog
\def\uni#1{\char"#1}
%%


%% BLOCK INDENT (option is integer number of \normalindent, [L,R])
\newenvironment{blockindent}[1][1]{%
  \begingroup%
  \StrDel{#1}{ }[\nvt@temp@s]%
  \nvt@oktrue%
  \IfInteger{\nvt@temp@s}{
    \FPdiv{\nvt@temp@d}{\strip@pt\textwidth}{\strip@pt\normalindent}%
    \FPiflt{\nvt@temp@s}{\nvt@temp@d}%
      \setlength\leftskip{\nvt@temp@s\normalindent}%
    \else\nvt@okfalse\fi%
  }{%
    \StrBefore{\nvt@temp@s}{,}[\nvt@temp@n]%
    \IfInteger{\nvt@temp@n}{%
      \FPiflt{\nvt@temp@n}{\nvt@temp@d}%
        \setlength\leftskip{\nvt@temp@n\normalindent}%
      \else\nvt@okfalse\fi%
    }{\nvt@okfalse}%
    \StrBehind{\nvt@temp@s}{,}[\nvt@temp@n]%
    \IfInteger{\nvt@temp@n}{%
      \FPiflt{\nvt@temp@n}{\nvt@temp@d}%
        \setlength\rightskip{\nvt@temp@n\normalindent}%
      \else\nvt@okfalse\fi%
    }{\nvt@okfalse}%
  }%
  \ifnvt@ok\else%
    \nvt@error{Bad option for \string\begin{blockindent}.^^J%
      Format: \string\begin{blockindent}[L,R]^^J%
      L is left indent, integer >=0 of normal paragraph indent.^^J%
      R is right indent, integer >=0 of normal paragraph indent.^^J%
      May use L alone, for only left indent.}%
  \fi%
}{\endgroup}
%%


%% TODO: limit to display pages %%%%%
\DeclareDocumentCommand\upscale{O{1}+m}{%
  \IfDecimal{#1}{}{%
    \nvt@error{Bad optional argument to \string\upscale.^^J%
      Must be integer|decimal number.}%
  }%
  \begingroup%
  \addfontfeature{ScaleAgain=#1}%
  \setlength\baselineskip{#1\nvt@leading}#2\par%
  \endgroup%
}
%%


%% small caps
\DeclareDocumentCommand\smcp{+m}{% lowercase to small caps
  {\addfontfeature{Letters=SmallCaps}#1}%
}
\DeclareDocumentCommand\allsmcp{+m}{% uppercase+lowercase to small caps
  {\addfontfeature{Letters=UppercaseSmallCaps,Letters=SmallCaps}#1}%
}
\let\textsc\smcp\relax % unified
\let\oldscshape\scshape\relax % unified
\let\scshape\smcp\relax % unified
%%


%% \lnum for lining numbers.
\gdef\lnum#1{{\addfontfeature{Numbers=ResetAll,%
  Numbers=Lining,RawFeature={+case}}#1}}
%%


%% \init[kern]{Letter}{phrase} for optional styling first line of a chapter.
\DeclareDocumentCommand\init{O{0}mm}{%
  \noindent\smash{\addfontfeature{ScaleAgain=1.33}#2}%
  \IfDecimal{#1}{\kern#1em}{%
    \ClassWarning{novelette}{Bad kern value in \string\init, page \thepage.^^J%
      This kern does not use units, just the number (units will be em).}%
  }%
  \smcp{#3}%
}
%%


%% Fake medium caps, if c2sc available:
\DeclareDocumentCommand\medcap{+m}{%
  {\addfontfeature{Letters=UppercaseSmallCaps,ScaleAgain=1.18,%
    FakeStretch=0.9}#1}%
}
\LetLtxMacro\medcaps\medcap\relax
%%


% \cleartorecto works same as \clearpage when next page is recto.
%   If next page would be verso, a blank verso is inserted,
%   so that the following material is recto.
% \cleartoend is used at very end of book.
%   It adds a blank page. If the blank is verso, end of book.
%   But if that blank is recto, it adds a second blank page, end of book.
%   So, the book always ends with a blank verso.
\gdef\cleartorecto{
  \clearpage
  \ifodd\c@page\else
    \thispagestyle{empty}\null\clearpage
  \fi
}
\gdef\cleartoend{
  \ifnvt@cleartoend\else
    \clearpage
    \ifodd\c@page
      \thispagestyle{empty}\null\clearpage
    \fi
    \thispagestyle{empty}\null\clearpage
  \fi
  \global\nvt@cleartoendtrue
}
%%


%%
\def\blankpage{%
  \clearpage%
  \thispagestyle{empty}%
  \null%
  \clearpage%
}
%%


\def\sups#1{%
  {\addfontfeature{Numbers=ResetAll,VerticalPosition=Superior}#1}%
}
\let\sup\sups\relax

\def\subs#1{%
  {\addfontfeature{Numbers=ResetAll,VerticalPosition=Inferior}#1}%
}
\let\sub\subs\relax



%%
\endinput
%%
%% End of file `novelette-utilities.sty'.
