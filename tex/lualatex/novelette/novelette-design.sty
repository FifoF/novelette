%% This is file `novelette-design.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-design.sty}%
[2023/01/20 v0.2 LaTeX file (page design calculations)]
%%


%% PAGE DESIGN CALCULATIONS
%% ----------------------------------------------------------------------------


%% TRIMSIZE AND SHEETFEED
\def\nvt@process@trimsize{
  \ifdimcomp{\nvt@trimw}{>}{0pt}{}{\trimsize{width=5.5in,height=8.5in}}
  \ifdefined\nvt@sheetfeed\else\sheetfeed{trimsize}\fi
  \nvt@oktrue
  \ifdimcomp{\nvt@trimw}{>}{\pagewidth}{\nvt@okfalse}{}
  \ifdimcomp{\nvt@trimh}{>}{\pageheight}{\nvt@okfalse}{}
  \ifnvt@ok\else
    \nvt@errTBFP % Too big for page.
    \global\setlength\pagewidth{\nvt@trimw}
    \global\setlength\pageheight{\nvt@trimh}
  \fi
}
%%


%% MARGINS
% Minimum P.O.D. margins are usually 0.5in/13mm top, outside, bottom,
% plus 0.125in/3mm inside. Novelette does not enforce these, but instead
% enforces much smaller values, just in case you are not using P.O.D.
\def\nvt@process@margins{
  \nvt@oktrue
  \ifdimcomp{\nvt@mtop}{>}{0pt}{ % User set values.
    \ifdimcomp{\nvt@mtop}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mtop}{>}{.25\nvt@trimh}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mout}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mout}{>}{.25\nvt@trimw}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mbot}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mbot}{>}{.25\nvt@trimh}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mins}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mins}{>}{.25\nvt@trimw}{\nvt@okfalse}{}
  }{}
  \ifnvt@ok\else
    \nvt@errMOOR % Margins out of range.
    \global\deflength\nvt@mtop{0pt} % Reset.
  \fi
  \ifdimcomp{\nvt@mtop}{=}{0pt}{ % Unset or reset.
    \FPsub{\nvt@temp@d}{\strip@pt\nvt@trimw}{398} % 398pt is 5.5in.
    \FPifgt{\nvt@temp@d}{0}
      \FPmul{\nvt@temp@d}{\nvt@temp@d}{.2}
    \else
      \def\nvt@temp@d{0}
    \fi
    \IfSubStr*{\log@trimsize}{mm}{ % Using Metric mm units.
      \FPdiv{\nvt@temp@d}{\nvt@temp@d}{2.845} % 2.845pt/mm.
      \FPadd{\nvt@temp@n}{\nvt@temp@d}{13}
      \FPround{\nvt@temp@n}{\nvt@temp@n}{2}
      \FPclip{\nvt@temp@n}{\nvt@temp@n}
      \global\deflength\nvt@mtop{\nvt@temp@n mm}
      \global\deflength\nvt@mout{\nvt@temp@n mm}
      \global\deflength\nvt@mbot{\nvt@temp@n mm}
      \FPadd{\nvt@temp@d}{\nvt@temp@n}{3}
      \FPclip{\nvt@temp@d}{\nvt@temp@d}
      \global\deflength\nvt@mins{\nvt@temp@d mm}
      \global\deflength\nvt@spinew{3mm}
      \xdef\log@margins{\string\margins{top=\nvt@temp@n mm, %
        outside=\nvt@temp@n mm, bottom=\nvt@temp@n mm, inside=\nvt@temp@d mm}}
    }{ % Something else, so use in.
      \FPdiv{\nvt@temp@d}{\nvt@temp@d}{72.27} % 72.27pt/in.
      \FPadd{\nvt@temp@n}{\nvt@temp@d}{.5}
      \FPround{\nvt@temp@n}{\nvt@temp@n}{3}
      \FPclip{\nvt@temp@n}{\nvt@temp@n}
      \global\deflength\nvt@mtop{\nvt@temp@n in}
      \global\deflength\nvt@mout{\nvt@temp@n in}
      \global\deflength\nvt@mbot{\nvt@temp@n in}
      \FPadd{\nvt@temp@d}{\nvt@temp@n}{.125}
      \FPclip{\nvt@temp@d}{\nvt@temp@d}
      \global\deflength\nvt@mins{\nvt@temp@d in}
      \global\deflength\nvt@spinew{.125in}
      \xdef\log@margins{\string\margins{top=\nvt@temp@n in, %
        outside=\nvt@temp@n in, bottom=\nvt@temp@n in, inside=\nvt@temp@d in}}
    }
  }{}
  \global\deflength\nvt@totalh{\nvt@trimh-\nvt@mtop-\nvt@mbot}
}
%%


%% FONT SIZE, GAPS, STYLE
\def\nvt@process@design{
  \FPsub{\nvt@temp@n}{\strip@pt\nvt@trimw}{\strip@pt\nvt@mout}
  \FPsub{\nvt@temp@n}{\nvt@temp@n}{\strip@pt\nvt@mins}
  \ifdimcomp{\nvt@fontsize}{>}{0pt}{}{
    \FPdiv{\nvt@temp@n}{\nvt@temp@n}{65} % Typical characters per line.
	\FPdiv{\nvt@temp@n}{\nvt@temp@n}{.45} % Typical character em width.
    \FPround{\nvt@temp@n}{\nvt@temp@n}{3}
    \FPclip{\nvt@temp@n}{\nvt@temp@n}
    \global\deflength\nvt@fontsize{\nvt@temp@n pt} 
  }
  \global\deflength\nvt@spad{0.08\nvt@fontsize} % Just a tiny amount.
  \global\deflength\textwidth{\nvt@trimw-\nvt@mout-\nvt@mins-2\nvt@spad}
  \ifdefined\nvt@headgap
    \ifdefined\nvt@footgap\else
      \gdef\nvt@footgap{\nvt@headgap}
    \fi
  \fi
  \ifdefined\nvt@openalign\else\gdef\nvt@openalign{c}\fi
  \ifdefined\nvt@footgap
    \ifdefined\nvt@headgap\else
      \gdef\nvt@headgap{\nvt@footgap}
    \fi
  \fi
  \ifdefined\nvt@headgap\else
    \ifdefined\nvt@footgap\else
      \gdef\nvt@headgap{0.5}
      \gdef\nvt@footgap{0.5}
    \fi
  \fi
  \ifdefined\nvt@hfstyle\else
    \ifdimcomp{\nvt@totalh}{<}{6.8in}{%
      \gdef\nvt@hfstyle{1} % Only footer.
    }{%
      \ifdimcomp{\nvt@totalh}{<}{7.2in}{%
        \gdef\nvt@hfstyle{3} % Only header.
      }{\gdef\nvt@hfstyle{2}} % Both.
    }
  \fi
  \FPiflt{\nvt@hfstyle}{4}\global\nvt@footertrue\fi
  \FPifgt{\nvt@hfstyle}{1}\global\nvt@headertrue\fi
  \FPifeq{\nvt@hfstyle}{0}\global\nvt@footerfalse\fi
  \ifnvt@pnital
    \gdef\pagenumber{\textit{\thepage}}
  \else
    \gdef\pagenumber{\thepage}
  \fi
  \global\deflength\oddsidemargin{%
    \nvt@mins+\nvt@spad+0.5\pagewidth-0.5\nvt@trimw-1in}
  \global\deflength\evensidemargin{%
    \nvt@mout+\nvt@spad+0.5\pagewidth-0.5\nvt@trimw-1in}
}
%%


%% CALCULATE LEADING, LINES PER PAGE
\def\nvt@calculate@leading{
  \setlength\nvt@temp@l{1.3\nvt@fontsize}
  \renewcommand\normalsize{%
    \@setfontsize\normalsize{\nvt@fontsize}{\nvt@temp@l}}
  \normalsize % Temporary.
  \sbox0{\mainfont 3456789JÀÁÂÃÄÅÇçjfhlygpqþ} % Highest and lowest Latin-1.
  \global\deflength\nvt@ascn{\ht0}
  \global\deflength\nvt@dscn{\dp0}
  \ifdefined\nvt@lpp\else\nvt@default@lpp\fi
  \ifnvt@header
    \ifnvt@footer
      \setlength\nvt@temp@l{\nvt@totalh}
      \FPadd{\nvt@temp@d}{\nvt@lpp}{2}
      \FPadd{\nvt@temp@d}{\nvt@temp@d}{\nvt@headgap}
      \FPadd{\nvt@temp@d}{\nvt@temp@d}{\nvt@footgap}
    \else
      \FPadd{\nvt@temp@d}{\nvt@lpp}{1}
      \FPadd{\nvt@temp@d}{\nvt@temp@d}{\nvt@headgap}
    \fi
  \else
    \ifnvt@footer
      \FPadd{\nvt@temp@d}{\nvt@lpp}{1}
      \FPadd{\nvt@temp@d}{\nvt@temp@d}{\nvt@footgap}
    \else
      \setlength\nvt@temp@l{\nvt@totalh+\nvt@ascn-2\nvt@dscn}
      \def\nvt@temp@d{\nvt@lpp}
    \fi
  \fi
  \FPdiv{\nvt@temp@n}{\strip@pt\nvt@temp@l}{\nvt@temp@d}
  \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{3}
  \global\deflength\nvt@leading{\nvt@temp@n pt}
  \global\deflength\baselineskip{\nvt@leading}

%%%%%
\ifnvt@header
  \ifnvt@footer
    \global\deflength\topmargin{\nvt@mtop+0.5\pageheight-0.5\nvt@trimh-1in}
    \global\deflength\topskip{\nvt@leading}
  \else

  \fi
\else
  \ifnvt@footer

  \else
    \global\deflength\topmargin{\nvt@mtop+0.5\pageheight-0.5\nvt@trimh%
      -1in-\nvt@leading+\nvt@ascn}
    \global\deflength\topskip{\nvt@leading}
  \fi
\fi
%%%%%

  \global\deflength\textheight{\nvt@lpp\nvt@leading}
  \FPround{\nvt@temp@n}{\strip@pt\nvt@fontsize}{4}%
  \FPclip{\nvt@temp@n}{\nvt@temp@n}%
  \xdef\log@design{%
    \string\design{fontsize=\nvt@temp@n pt,lines=\nvt@lpp,%
    headgap=\nvt@headgap,footgap=\nvt@footgap,%
    style=\nvt@hfstyle\ifnvt@pnital i\fi,%
    opening=\nvt@openalign}%
  }
}
%%
\def\nvt@default@lpp{
  \FPmul{\nvt@temp@n}{\strip@pt\nvt@fontsize}{1.3}
  \FPdiv{\nvt@temp@n}{\strip@pt\nvt@totalh}{\nvt@temp@n}
  \ifnvt@header
    \FPsub{\nvt@temp@n}{\nvt@temp@n}{1}
    \FPsub{\nvt@temp@n}{\nvt@temp@n}{\nvt@headgap}
  \fi
  \ifnvt@footer
    \FPsub{\nvt@temp@n}{\nvt@temp@n}{1}
    \FPsub{\nvt@temp@n}{\nvt@temp@n}{\nvt@footgap}
  \fi
  \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}
  \xdef\nvt@lpp{\nvt@temp@n}
}
%%


%% GUIDES
\def\nvt@process@guides{
  \StrDel{\nvt@guides,}{ }[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@n]
  \ifthenelse{\equal{\nvt@temp@n}{}}{}{
    \IfInteger{\nvt@temp@n}{
      \xdef\nvt@guidea{\nvt@temp@n}
      \StrBehind{\nvt@temp@s}{,}[\nvt@temp@s]
      \StrBefore{\nvt@temp@s}{,}[\nvt@temp@d]
      \ifthenelse{\equal{\nvt@temp@d}{}}{}{
        \IfInteger{\nvt@temp@d}{
          \xdef\nvt@guideb{\nvt@temp@d}
        }{
          \nvt@warnBVG % Bad value in guides.
        }
      }
    }{
      \nvt@warnBVG
    }
  }
}
%%


%% RENEW NORMALSIZE
\def\nvt@renew@normalsize{
  \renewcommand\normalsize{%
    \@setfontsize\normalsize{\nvt@fontsize}{\nvt@leading}}
  \normalsize
  \let\@normalsize\normalsize\relax % Hack for fancyhdr.
  \global\deflength\normalindent{1.5\nvt@fontsize}
  \global\deflength\footnotesep{0.8\nvt@leading}
  \DeclareRobustCommand\@footnotesize{% For actual footnotes.
    \@setfontsize\@footnotesize{.92\nvt@fontsize}{.92\nvt@leading}%
  }
  \let\tiny\normalsize\relax
  \let\scriptsize\normalsize\relax
  \let\footnotesize\normalsize\relax % See \@footnotesize.
  \let\small\normalsize\relax
  \let\large\normalsize\relax
  \let\Large\normalsize\relax
  \let\LARGE\normalsize\relax
  \let\huge\normalsize\relax
  \let\Huge\normalsize\relax
  \let\HUGE\normalsize\relax
  \sbox0{\mainfont 3456789JÀÁÂÃÄÅÇçjfhlygpqþ} % Highest and lowest Latin-1.
  \global\deflength\nvt@ascn{\ht0}
  \global\deflength\nvt@dscn{\dp0}
  \setlength\nvt@temp@l{\nvt@ascn+\nvt@dscn}
  \FPdiv{\nvt@temp@n}{\strip@pt\nvt@temp@l}{\strip@pt\nvt@leading}
  \FPifgt{\nvt@temp@n}{1}\nvt@errTMLPP\fi
  \ifnvt@header
    \global\deflength\headheight{\nvt@leading}
    \global\deflength\headsep{\nvt@headgap\nvt@leading-\nvt@dscn}
  \fi
  \ifnvt@footer
    \global\deflength\footskip{\nvt@footgap\nvt@leading+\nvt@leading}
  \fi
}
%%


%%
\endinput
%%
%% End of file `novelette-design.sty'.
