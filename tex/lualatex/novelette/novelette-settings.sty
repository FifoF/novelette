%% This is file `novelette-settings.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-settings.sty}%
[2023/01/20 v0.2 LaTeX file (book and page design settings)]
%%


%% BOOK TRIM SIZE AND PAGE DESIGN SETTINGS
% -----------------------------------------------------------------------------
% These define the dimensions and styles of your book, and its page design.
% Fonts, openings, and metadata are defined in other files.
%   If you set \trimsize, you must set both width,height.
%   If you set \margins, you must set all of top,outside,bottom,inside.
%   If you set \design, you may set some or all of its values.
% Novelette provides defaults for anything you do not set. In some cases,
% the defaults are based on other settings or defaults.
%   These settings are parsed for syntax and acceptable values, at the time
% they are read. The values are not activated until AtEndPreamble or later,
% since they must be processed in a certain order. See novelette-design.sty.
%%
% \nvt@trimws, \nvt@trimhs -> Strings parsed from \trimsize{} command.
% \nvt@trimw, \nvt@trimh   -> Corresponding lengths, stored as TeX pt.
% \nvt@mtop, \nvt@mout, \nvt@mbot, \nvt@min -> Margins in TeX pt.
%   Top, Outside, Bottom, Inside (spine) margins.
%   Margins exclude all printed material. Header/footer do not sit within
%   the margins, but sit within the same rectangle as main text. 
% \nvt@lpp -> Integer lines per page, main textblock (not header/footer).
% \nvt@headgap, \nvt@footgap -> Increase line space from main to header|footer.
%   Range 0-1, may be decimal. Value 1 means one full blank line gap.
% \nvt@hfstyle -> Chooses the style of header/footer.
%   Settings for fonts, and header style formats, are in other files.
%%


%% Utility: Check if string can be used to set a length (number with units).
\newcommand\nvt@checklength[1]{
  \nvt@okfalse
  \IfEndWith{#1}{in}{\nvt@oktrue}{}
  \IfEndWith{#1}{mm}{\nvt@oktrue}{}
  \IfEndWith{#1}{cm}{\nvt@oktrue}{}
  \IfEndWith{#1}{pt}{\nvt@oktrue}{}
  \IfEndWith{#1}{bp}{\nvt@oktrue}{}
  \StrGobbleRight{#1}{2}[\nvt@temp@ckln]
  \IfDecimal{\nvt@temp@ckln}{}{\nvt@okfalse}
}
%%


%% TRIM SIZE (Finished page size of the book.)
\newcommand\trimsize[1]{
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{width=}[\nvt@temp@n]
  \StrBefore{\nvt@temp@n}{,}[\nvt@temp@n]
  \nvt@checklength{\nvt@temp@n}
  \StrDel{#1,}{ }[\nvt@temp@d]
  \StrBehind{\nvt@temp@d}{height=}[\nvt@temp@d]
  \StrBefore{\nvt@temp@d}{,}[\nvt@temp@d]
  \nvt@checklength{\nvt@temp@d}
  \ifdimcomp{\nvt@temp@n}{<}{4in}{\nvt@okfalse}{}
  \ifdimcomp{\nvt@temp@n}{>}{12in}{\nvt@okfalse}{}
  \ifdimcomp{\nvt@temp@d}{<}{6in}{\nvt@okfalse}{}
  \ifdimcomp{\nvt@temp@d}{>}{18in}{\nvt@okfalse}{}
  \ifdimcomp{\nvt@temp@d}{<}{\nvt@temp@n}{\nvt@okfalse}{}
  \ifnvt@ok
    \global\deflength\nvt@trimw{\nvt@temp@n}
    \global\deflength\nvt@trimh{\nvt@temp@d}
    \global\deflength\pagewidth{\nvt@trimw}
    \global\deflength\pageheight{\nvt@trimh}
  \else
    \nvt@errBTS % Bad trim size.
  \fi
  \xdef\log@trimsize{\string\trimsize{#1}}
}
\@onlypreamble\trimsize
%%


%% SHEETFEED (Normally not used. See Novelette documentation.)
\newcommand\sheetfeed[1]{
  \nvt@okfalse
  \StrDel{#1}{ }[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{}}{\nvt@oktrue\gdef\nvt@temp@s{trimsize}}{}
  \ifthenelse{\equal{\nvt@temp@s}{trimsize}}{\nvt@oktrue}{}
  \ifthenelse{\equal{\nvt@temp@s}{letter}}{\nvt@oktrue}{}
  \ifthenelse{\equal{\nvt@temp@s}{A4}}{\nvt@oktrue}{}
  \ifthenelse{\equal{\nvt@temp@s}{a4}}{\nvt@oktrue\gdef\nvt@temp@s{A4}}{}
  \ifnvt@ok
    \xdef\nvt@sheetfeed{\nvt@temp@s}
  \else
    \nvt@errBVSF % Bad value sheetfeed.
    \gdef\nvt@sheetfeed{trimsize}
  \fi
  \gdef\log@sheetfeed{\string\sheetfeed{\nvt@sheetfeed}}
}
\@onlypreamble\sheetfeed
%%


%% MARGINS (Excludes all printable material. Inside is at spine.)
\newcommand\margins[1]{
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{top=}[\nvt@temp@t]
  \StrBefore{\nvt@temp@t}{,}[\nvt@temp@t]
  \nvt@checklength{\nvt@temp@t}
  \StrDel{#1,}{ }[\nvt@temp@o]
  \StrBehind{\nvt@temp@o}{outside=}[\nvt@temp@o]
  \StrBefore{\nvt@temp@o}{,}[\nvt@temp@o]
  \nvt@checklength{\nvt@temp@o}
  \StrDel{#1,}{ }[\nvt@temp@b]
  \StrBehind{\nvt@temp@b}{bottom=}[\nvt@temp@b]
  \StrBefore{\nvt@temp@b}{,}[\nvt@temp@b]
  \nvt@checklength{\nvt@temp@b}
  \StrDel{#1,}{ }[\nvt@temp@i]
  \StrBehind{\nvt@temp@i}{inside=}[\nvt@temp@i]
  \StrBefore{\nvt@temp@i}{,}[\nvt@temp@i]
  \nvt@checklength{\nvt@temp@i}
  \ifnvt@ok
    \global\deflength\nvt@mtop{\nvt@temp@t}
    \global\deflength\nvt@mout{\nvt@temp@o}
    \global\deflength\nvt@mbot{\nvt@temp@b}
    \global\deflength\nvt@mins{\nvt@temp@i}
  \else
    \StrDel{#1}{ }[\nvt@temp@t]
    \nvt@checklength{\nvt@temp@t}
    \ifnvt@ok
      \global\deflength\nvt@mtop{\nvt@temp@t}
      \global\deflength\nvt@mout{\nvt@temp@t}
      \global\deflength\nvt@mbot{\nvt@temp@t}
      \IfSubStr*{\nvt@temp@t}{mm}{
        \global\deflength\nvt@mins{\nvt@mtop+3mm}
      }{
        \global\deflength\nvt@mins{\nvt@mtop+.125in}
      }
    \else
      \nvt@errBVMAR % Bad value margins.
    \fi
  \fi
  \xdef\log@margins{\string\margins{#1}}
  \IfSubStr{\log@margins}{mm}{
    \global\deflength\nvt@spinew{3mm}
  }{
    \global\deflength\nvt@spinew{.125in}
  }
}
\@onlypreamble\margins % Default will be calculated, based on trim size.
%%


%% SIDE PADDING (normally not a user setting)
\gdef\nvt@spadval{.1} % em
%%

%% PAGE DESIGN (fontsize, lines, headgap, footgap, style, opening)
% fontsize = integer|decimal main font size, with units pt|bp.
% emperline = integer|decimal em per line of main text.
%   You may set at most one of fontsize|emperline. The other is calculated. 
% lines = integer lines per page, main textblock (not counting header/footer).
% headgap, footgap = integer|decimal 0-1. Extra line space at header/footer.
% style = integer 1-7. Selects header/footer style. i = italics page number.
% opening = l|c|r. Sets default horizontal alignment of items in openings.
\newcommand\design[1]{
  \nvt@oktrue
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{fontsize=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{}}{}{
    \nvt@checklength{\nvt@temp@s}
    \ifnvt@ok\global\deflength\nvt@fontsize{\nvt@temp@s}\fi
  }
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{emperline=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{}}{}{
    \xdef\nvt@emperline{\nvt@temp@s}
    \global\nvt@epltrue
  }
  \ifdimcomp{\nvt@fontsize}{>}{0pt}{
    \ifnvt@epl
       \nvt@errCSBFE % Cannot set both fontsize and emperline.
       \global\nvt@eplfalse % Priority to fontsize or default.
    \fi
  }{}
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{lines=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{}}{}{
    \IfInteger{\nvt@temp@s}{
      \FPiflt{\nvt@temp@s}{12}
        \nvt@okfalse
      \else
        \FPifgt{\nvt@temp@s}{72}
          \nvt@okfalse
        \else
          \xdef\nvt@lpp{\nvt@temp@s}
        \fi
     \fi
    }{\nvt@okfalse}
  }
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{headgap=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{}}{}{
    \IfDecimal{\nvt@temp@s}{
      \FPiflt{\nvt@temp@s}{0}
        \nvt@okfalse
      \else
        \FPifgt{\nvt@temp@s}{1}
          \nvt@okfalse
        \else
          \xdef\nvt@headgap{\nvt@temp@s}
        \fi
     \fi
    }{\nvt@okfalse}
  }
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{footgap=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{}}{}{
    \IfDecimal{\nvt@temp@s}{
      \FPiflt{\nvt@temp@s}{0}
        \nvt@okfalse
      \else
        \FPifgt{\nvt@temp@s}{1}
          \nvt@okfalse
        \else
          \xdef\nvt@footgap{\nvt@temp@s}
        \fi
     \fi
    }{\nvt@okfalse}
  }
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{style=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \IfSubStr{\nvt@temp@s}{i}{\global\nvt@pnitaltrue\StrDel{\nvt@temp@s}{i}[\nvt@temp@s]}{}
  \ifthenelse{\equal{\nvt@temp@s}{}}{}{
    \IfInteger{\nvt@temp@s}{
      \FPiflt{\nvt@temp@s}{0}
        \nvt@okfalse
      \else
        \FPifgt{\nvt@temp@s}{7}
          \nvt@okfalse
        \else
          \xdef\nvt@hfstyle{\nvt@temp@s}
        \fi
     \fi
    }{\nvt@okfalse}
  }
  \StrDel{#1,}{ }[\nvt@temp@s]
  \StrBehind{\nvt@temp@s}{opening=}[\nvt@temp@s]
  \StrBefore{\nvt@temp@s}{,}[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{}}{\def\nvt@temp@s{c}}{}
  \ifthenelse{\equal{\nvt@temp@s}{c} \OR %
    \equal{\nvt@temp@s}{l} \OR \equal{\nvt@temp@s}{r} \OR %
    \equal{\nvt@temp@s}{o} \OR \equal{\nvt@temp@s}{i}}{
      \xdef\nvt@openalign{\nvt@temp@s}
  }{
    \nvt@errBVDES % Bad value for design.
    \gdef\nvt@openalign{c}    
  }
}
\@onlypreamble\design % Defaults will be calculated. Also \log@design.
%%


%% GUIDES (up to two guides, visible in margin with mode shade|align)
\newcommand\guides[1]{\gdef\nvt@guides{#1}}
\@onlypreamble\guides % Default is no guides.
%%


%% FOOTNOTE REFERENCE MARKS (literary or numerical)
\newcommand\markers[1]{
  \nvt@okfalse
  \StrDel{#1}{ }[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{*}}{\nvt@oktrue\gdef\nvt@markers{*}}{}
  \ifthenelse{\equal{\nvt@temp@s}{1}}{\nvt@oktrue\gdef\nvt@markers{1}}{}
  \ifnvt@ok\else\nvt@errBVFM\fi% Bad value for footnote markers.
  \xdef\lognvt@markers{\string\markers{#1}}
}
\markers{*} % Default.
\@onlypreamble\markers
%%


%% MICROTYPE OPTIONS
% Novelette loads microtype automatically, AtEndPreamble. This is equivalent
% to \PassOptionsToPackage{microtype}, but passes \nvt@MT instead:
\DeclareDocumentCommand\setmicrotype{m}{% Undefined before loading microtype.
  \StrDel{#1}{ifdraft}[\nvt@temp@s]
  \StrDel{\nvt@temp@s}{draft}[\nvt@temp@s]
  \StrDel{\nvt@temp@s}{final}[\nvt@temp@s]
  \IfSubStr{\nvt@temp@s}{config}{}{
    \g@addto@macro\nvt@temp@s{,config=novelette-microtype}
  }
  \IfSubStr{\nvt@temp@s}{verbose}{}{\g@addto@macro\nvt@temp@s{,verbose=silent}}
  \xdef\nvt@MT{\nvt@temp@s}
}
\setmicrotype{stretch=20,shrink=20,protrusion=true} % And others. Default.
\@onlypreamble\setmicrotype
\def\nvt@process@MT{ % AtEndPreamble.
  \ifundef\nvt@MT{
    \setmicrotype{config=novelette-microtype,stretch=20,shrink=20,%
      protrusion=true,verbose=silent}
  }{}
  \xdef\log@mto{\string\microtypesetup{\nvt@MT}}
}
%%



%%
\endinput
%%
%% End of file `novelette-settings.sty'.
