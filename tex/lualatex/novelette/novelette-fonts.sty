%% This is file `novelette-fonts.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-fonts.sty}%
[2023/01/20 v0.2 LaTeX file (font settings and defaults)]
%%


%% FONTS
% Novelette uses fontspec technology, with Open Type (or some TrueType) fonts.
%   The main font is used for body text. With modifications (such as Scale)
% it is also used for header/footer, footnotes, and opening name/desc.
%   The deco font may only be used on the book Title page, half-title, and
% Part separator pages. It is intended for dramatic effect. If you do not
% set the deco font, then the main font will be used, with modifications.
%   If the main font is neither EB Garamond nor Libertinus Serif, then the
% alt font is set to one of these, if available. These fonts provide many
% characters (such as Greek and Cyrillic) that may not be available in the
% main font.
%   Note that unless you do code hacks, you have very little choice for how
% fonts are used. In the past, authors never chose (metal) fonts; they were
% chosen by the printer. Good enough for Victor Hugo, good enough for you!
%%


%% DO NOT USE DIRECTLY
\pretocmd\setmainfont{%
  \ifdefined\nvt@main@font\else%
    \nvt@error{Do not use command \string\setmainfont.^^J%
      Novelette uses \string\setfont{main}{Font Name}[features] instead.}%
  \fi%
}{}{}
%%


%% FONT SELECTION
\DeclareDocumentCommand\setfont{mmO{}}{
  \nvt@okfalse
  \StrDel{#1}{ }[\nvt@temp@s]
  \ifthenelse{\equal{\nvt@temp@s}{main}}{
    \nvt@oktrue\gdef\nvt@main@font{#2}\gdef\nvt@main@feat{#3}
  }{}
  \ifthenelse{\equal{\nvt@temp@s}{deco}}{
    \nvt@oktrue\gdef\nvt@deco@font{#2}\gdef\nvt@deco@feat{#3}
  }{}
  \ifnvt@ok\else
    \nvt@error{Bad first argument in \string\setfont.^^J%
      Choices: main deco}
  \fi
}
\@onlypreamble\setfont
%%


%%
\def\nvt@process@mainfont{
  \ifdefined\nvt@main@feat\else\gdef\nvt@main@feat{}\fi
  \ifdefined\nvt@main@font\else
    \IfFontExistsTF{EB Garamond}{
      \gdef\nvt@main@font{EB Garamond}
    }{
      \IfFontExistsTF{Libertinus Serif}{
        \gdef\nvt@main@font{Libertinus Serif}
      }{
        \IfFontExistsTF{Latin Modern Roman}{
          \gdef\nvt@main@font{Latin Modern Roman}
          \ClassWarningNoLine{novelette}{Did not find suitable default font.^^J%
            Using Latin Modern Roman. For best appearance, select another.}
        }{
          \nvt@error{Looked for Latin Modern Roman^^J%
            as last-choice default main font, but did not find it.^^J%
            Your TeX system may be missing some standard files.}
        }
      }
    }
  \fi
  \setmainfont{\nvt@main@font}[\nvt@main@feat,RawFeature={colr=0}]
  \let\mainfont\rmfamily\relax
  \def\nvt@temp@n{}
  \ifthenelse{\equal{\nvt@main@feat}{}}{}{\def\nvt@temp@n{[\nvt@main@feat]}}
  \xdef\log@mainfont{\string\setfont{main}{\nvt@main@font}\nvt@temp@n}
}
%%


%%
\def\nvt@process@decofont{
  \ifdefined\nvt@deco@font\else\xdef\nvt@deco@font{\nvt@main@font}\fi
  \ifdefined\nvt@deco@feat\else\xdef\nvt@deco@feat{\nvt@main@feat}\fi
  \IfFontExistsTF{\nvt@deco@font}{
    \newfontfamily\decofont{\nvt@deco@font}[\nvt@deco@feat,%
      Ligatures=ResetAll,Ligatures=TeX,RawFeature={colr=0}]
  }{
    \ClassWarningNoLine{novelette}{Did not find deco font \nvt@deco@font.^^J%
      Will use main font instead. Results will not be as intended.}
    \newfontfamily\decofont{\nvt@main@font}[\nvt@main@feat,%
      Ligatures=ResetAll,Ligatures=TeX,RawFeature={colr=0}]
  }
  \def\nvt@temp@n{}
  \ifthenelse{\equal{\nvt@deco@feat}{}}{}{\def\nvt@temp@s{[\nvt@deco@feat]}}
  \xdef\log@decofont{\string\setfont{deco}{\nvt@deco@font}\nvt@temp@n}
}
%%


%%
\def\nvt@process@otherfonts{
  % \altfont (always Libertinus Serif, if available)
  \IfFontExistsTF{Libertinus Serif}{
    \newfontfamily\altfont{Libertinus Serif}[Scale=MatchLowercase,%
      RawFeature={colr=0}]
  }{
    \let\altfont\relax
  }
  % \nvt@headfont
  \ifthenelse{\equal{\nvt@hfscale}{1}}{
    \gdef\nvt@hfstretch{}
  }{
    \FPsub{\nvt@temp@n}{1}{\nvt@hfscale}
    \FPdiv{\nvt@temp@n}{\nvt@temp@n}{2}
    \FPadd{\nvt@temp@n}{\nvt@temp@n}{\nvt@hfscale}
    \xdef\nvt@hfstretch{FakeStretch=\nvt@temp@n}
  }
  \newfontfamily\nvt@headfont{\nvt@main@font}[\nvt@main@feat,%
    Ligatures=ResetAll,Ligatures=TeX,RawFeature={colr=0},%
    Scale=\nvt@hfscale,\nvt@hfstretch]
  % \nvt@name@font
  \newfontfamily\nvt@namefont{\nvt@main@font}[\nvt@main@feat,Scale=1.8,%
    Ligatures=ResetAll,Ligatures=TeX,RawFeature={colr=0},%
    FakeStretch=.9,LetterSpace=2]
  % \nvt@desc@font
  \newfontfamily\nvt@descfont{\nvt@main@font}[\nvt@main@feat,Scale=1.33,%
    Ligatures=ResetAll,Ligatures=TeX,RawFeature={colr=0},%
    FakeStretch=.94,LetterSpace=2]
}
%%



%%
\endinput
%%
%% End of file `novelette-fonts.sty'


