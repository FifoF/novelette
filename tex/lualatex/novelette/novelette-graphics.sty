%% This is file `novelette-graphics.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-graphics.sty}%
[2023/01/20 v0.2 LaTeX file (alternative to graphics and color)]
%%


%% LIMITED GRAPHICS, LIMITED GRAY COLOR
%% ----------------------------------------------------------------------------
% Standard LaTeX color management is contained in the graphics bundle,
% by David Carlisle, Sebastian Rahtz, and other members of the LaTeX project,
% and individual authors. Shout-out to them!
%   However, Novelette only allows monochrome black/white, except limited
% grayscale shades, for alignment purposes, in draft mode. And, Novelette
% restricts images to monochrome 1-bit per pixels black/white png format,
% without the ability to rotate, scale, crop, or otherwise transform.
%   Thus, the standard LaTeX color files are not loaded. Novelette uses its
% own code for (non-) color.
%%


%% WARN WHEN ATTEMPTING TO USE STANDARD COLOR COMMANDS
\def\nvt@colormsg{\ifnvt@sent@colormsg\else\nvt@warnNOC\fi}
\DeclareDocumentCommand\color{O{}m}{\nvt@colormsg\ignorespaces}
\def\textcolor#1#2{\leavevmode\nvt@colormsg #2}
\def\colorbox#1#2{\leavevmode\nvt@colormsg #2}
\def\pagecolor#1{\nvt@colormsg}
\def\nopagecolor{\nvt@colormsg}
\def\definecolor#1#2#3{\nvt@colormsg}
\def\DefineNamedColor#1#2#3#4{\nvt@colormsg}
\def\normalcolor{}
%%


%% DRAFT MODE GRAY SHADES
\def\@black{0 g 0 G}
\def\nvt@shade{0 g 0 G}
\def\@newcolor{%
  \pdfextension colorstack 0 push{\nvt@shade}%
  \aftergroup\@prevcolor%
}
\def\@prevcolor{\pdfextension colorstack 0 pop\relax}
\DeclareRobustCommand\nvt@gray[1]{\def\nvt@shade{#1 g #1 G}\@newcolor\ignorespaces}
\protected\def\nvt@textgray#1#2{{\nvt@shade{#1}#2}}
%%


%% IMAGES IN NOVELETTE
% Standard LaTeX graphics uses the graphics bundle, which has several files.
% Those files were written by David Carlisle, Sebastian Rahtz, and other
% members of the LaTeX project and individual authors. Shout-out to them!
%   However, Novelette uses its own graphics code. In particular: You may only
% use png images (or fake box, in draft mode). You may not rotate, scale, crop.
% No frames. No captions. No 2-column.
%   Why not simply load the graphics package? It contains many commands that
% cannot be used in Novelette, and places things somewhat differently than
% Novelette wants to place them.
%   If you attempt to use the standard \includegraphics command, then instead
% Novelette will throw a rude error:
\DeclareDocumentCommand\includegraphics{sO{}m}{\nvt@errNING}% No \includegraphics.
%%


%% IMAGE
% Syntax: \image[options]{integer or filename.png}
% Option t b p floats top, bottom, fullpage. Default n (unfloated).
% Option l c r aligns left, center, right. Default c, except in opening.
% If an integer is provided (instead of an image filename), then in draft mode
% Novelette creates a fake image (gray box) occupying that many lines of text.
% If in final mode, fake image is error.
% Real image must have extension png or PNG. No other image format allowed.
% In draft mode, or if not using PDF/X, image check is superficial.
% When using PDF/X in final mode, image check is more comprehensive.
\def\nvt@imgfilename{}
\newsavebox\nvt@imgbox
\def\ftype@figure{1} % Mystery TeX code.
\DeclareDocumentCommand\image{O{}m}{%
\vspace*{-\nvt@leading}\null%
  \begingroup%
  \def\nvt@imgfilename{#2}%
  \setlength\parindent{0pt}%
  \nvt@TestImagePlacement{#1}%
  \nvt@TestImageFormat{#2}%
  \ifthenelse{\equal{\nvt@imgformat}{real}}{%
    \nvt@ValidateImageFile{#2}%
    \@addtofilelist{#2}\ProvidesFile{#2}[png image]%
    \saveimageresource attr{/Interpolate true } cropbox {#2}%
    \sbox\nvt@imgbox{\useimageresource\the\lastsavedimageresourceindex}%
  }{%
    \sbox\nvt@imgbox{\nvt@gray{.5}%
      \rule[\nvt@ascn]{.5\textwidth}%
        {\nvt@dscn+\nvt@intht\nvt@leading-\nvt@leading+\nvt@ascn}%
    }%
  }%
  \setlength\nvt@imgwidth{\wd\nvt@imgbox}%
  \setlength\nvt@imgheight{\ht\nvt@imgbox}%
  \FPdiv{\nvt@temp@n}{\strip@pt\nvt@imgheight}{\strip@pt\nvt@leading}%
  \FPadd{\nvt@temp@n}{\nvt@temp@n}{1}%
  \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}%
  \setlength\nvt@intht{\nvt@temp@n\nvt@leading}%
  \ifthenelse{\equal{\nvt@floatpos}{n}}{\nvt@nofloatimg}{}%
  \ifthenelse{\equal{\nvt@floatpos}{t}}{\nvt@topfloatimg}{}%
  \ifthenelse{\equal{\nvt@floatpos}{b}}{\nvt@botfloatimg}{}%
  \ifthenelse{\equal{\nvt@floatpos}{h}}{\nvt@herefloatimg}{}%
  \ifthenelse{\equal{\nvt@floatpos}{p}}{\nvt@pgfloatimg}{}%
  \ifthenelse{\equal{\nvt@floatpos}{i}}{\nvt@inlineimg}{}%
  \endgroup%
}
%%


%% ICON (inline image)
\DeclareDocumentCommand\icon{O{}m}{\image[i]{#2}}
\def\nvt@inlineimg{%
  \setlength\nvt@temp@l{\nvt@ascn+\nvt@dscn}%
  \ifdimcomp{\nvt@imgheight}{>}{\nvt@temp@l}{%
    \FPmul{\nvt@temp@n}{\strip@pt\nvt@temp@l}{8.3022}%
    \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}%
    \nvt@errIITT{\nvt@imgfilename}{\nvt@temp@n}% Icon image too tall.
  }{%
    \raisebox{-\nvt@dscn}{\usebox\nvt@imgbox}%
  }%
}
%%


%% TEST IMAGE PLACEMENT
\newcommand\nvt@TestImagePlacement[1]{% No error or warning, if bad value.
  \def\nvt@imgpos{c}%
  \IfSubStr{#1}{l}{\def\nvt@imgpos{l}}{}%
  \IfSubStr{#1}{r}{\def\nvt@imgpos{r}}{}%
  \def\nvt@floatpos{n}% Default no float.
  \IfSubStr{#1}{t}{\def\nvt@floatpos{t}}{}%
  \IfSubStr{#1}{b}{\def\nvt@floatpos{b}}{}%
  \IfSubStr{#1}{p}{\def\nvt@floatpos{p}}{}%
  \IfSubStr{#1}{h}{\def\nvt@floatpos{h}}{}% Actually ht.
}
%%


%% TEST IMAGE FORMAT
\newcommand\nvt@TestImageFormat[1]{%
  \def\nvt@imgformat{fake}%
  \nvt@okfalse%
  \IfEndWith{#1}{.png}{\nvt@oktrue}{}%
  \IfEndWith{#1}{.PNG}{\nvt@oktrue}{}%
  \ifnvt@ok%
    \IfBeginWith*{#1}{/}{\nvt@okfalse}{% No absolute path.
      \IfBeginWith*{#1}{..}{\nvt@okfalse}{% No escape from document directory.
        \IfFileExists{#1}{}{\nvt@okfalse}%
      }%
    }%
  \fi%
  \ifnvt@ok%
    \def\nvt@imgformat{real}%
  \else%
    \StrDel{#1}{ }[\nvt@temp@n]%
    \IfInteger{\nvt@intht}{\nvt@oktrue\setlength\nvt@intht{\nvt@temp@n}}{}%
  \fi%
  \ifnvt@ok\else%
    \setlength\nvt@intht{2\nvt@leading}\nvt@errBIMF% Bad image format.
  \fi%
}
%%


%% VALIDATE IMAGE
\def\nvt@ValidateImageFile#1{%
  \nvt@oktrue%
    %%%%% Put validation routine here.
  \ifnvt@ok\else%
    \ifnvt@draft\nvt@warnIWNP\else\nvt@errIWNP\fi%
  \fi%
}
%%


%% UNFLOATED IMAGE
\def\nvt@nofloatimg{%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{r}}{\hfill}{}%
  \rule{0pt}{\nvt@intht}%
  \usebox\nvt@imgbox%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{l}}{\hfill}{}%
  \par%
}
%%


%% TOP FLOAT
\def\nvt@topfloatimg{%
  \def\fps@figure{t}%
  \@float{figure}%
  \leavevmode%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{r}}{\hfill}{}%
  \rule{0pt}{\nvt@intht}%
  \usebox{\nvt@imgbox}%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{l}}{\hfill}{}%
  \par%
  \end@float%
}
%%


%% HERE FLOAT
\def\nvt@herefloatimg{%
  \def\fps@figure{ht}%
  \@float{figure}%
  \leavevmode%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{r}}{\hfill}{}%
  \rule{0pt}{\nvt@intht}%
  \usebox{\nvt@imgbox}%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{l}}{\hfill}{}%
  \par%
  \end@float%
}
%%


%% BOTTOM FLOAT
\def\nvt@botfloatimg{%
  \def\fps@figure{b}%
  \@float{figure}%
  \leavevmode%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{r}}{\hfill}{}%
%%%  \rule{0pt}{\nvt@intht}%
  \usebox{\nvt@imgbox}%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{l}}{\hfill}{}%
  \par%
  \end@float%
}
%%


%% FULL PAGE FLOAT
\def\nvt@pgfloatimg{%
  \def\fps@figure{p}%
  \@float{figure}%
  \vspace*{\nvt@leading-\nvt@ascn}%
  \leavevmode%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{r}}{\hfill}{}%
  \usebox\nvt@imgbox%
  \ifthenelse{\equal{\nvt@imgpos}{c}}{\hfil}{}%
  \ifthenelse{\equal{\nvt@imgpos}{l}}{\hfill}{}%
  \par%
  \end@float%
%  \vfil%
}
%%


%% IMAGE SPECIFICATIONS (Suggest image sizes, base on design.)
\def\log@imagespecs{
  \FPsub{\nvt@temp@n}{\strip@pt\textwidth}{.1}%
  \FPdiv{\nvt@temp@n}{\nvt@temp@n}{72.27}%
  \FPmul{\nvt@temp@n}{\nvt@temp@n}{600}%
  \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}%
  \typeout{Max image width, @600ppi: \nvt@temp@n\space pixels.}%
  \FPadd{\nvt@temp@n}{\strip@pt\nvt@ascn}{\strip@pt\nvt@dscn}%
  \FPmul{\nvt@temp@n}{\nvt@temp@n}{8.3022} % TeX pt to 600ppi.
  \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}%
  \typeout{Max height of icon image, @600ppi: \nvt@temp@n\space pixels.}%
  \FPmul{\nvt@temp@d}{\strip@pt\nvt@dscn}{8.3022}%
  \FPtrunc{\nvt@temp@d}{\nvt@temp@d}{0}%
  \typeout{Text baseline above icon image bottom, %
    @600ppi: \nvt@temp@d\space pixels.}%
  \FPdiv{\nvt@temp@d}{\strip@pt\nvt@leading}{72.27}%
  \FPmul{\nvt@temp@d}{\nvt@temp@d}{600}%
  \FPtrunc{\nvt@temp@d}{\nvt@temp@d}{0}%
  \FPadd{\nvt@temp@r}{\nvt@temp@d}{\nvt@temp@n}%
  \FPtrunc{\nvt@temp@r}{\nvt@temp@r}{0}%
  \typeout{Max height of two-line image, @600ppi: \nvt@temp@r\space pixels.}%
  \typeout{Each additional line @600ppi: add \nvt@temp@d\space pixels.}%
  \FPmul{\nvt@temp@n}{\strip@pt\nvt@dscn}{1.004}%
  \FPsub{\nvt@temp@n}{\strip@pt\textheight}{\nvt@temp@n}%
  \FPdiv{\nvt@temp@n}{\nvt@temp@n}{72.27}%
  \FPmul{\nvt@temp@n}{\nvt@temp@n}{600}%
  \FPtrunc{\nvt@temp@n}{\nvt@temp@n}{0}%
  \typeout{Max height of full-page image, @600ppi: \nvt@temp@n\space pixels.}
}
%%


%%
\endinput
%%
%% End of file `novelette-graphics.sty'.
