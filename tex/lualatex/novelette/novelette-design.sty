%% This is file `novelette-design.sty',
%% part of `novelette' document class.
%% Copyright 2023 Robert Allgeyer.
%%
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
\ProvidesFile{novelette-design.sty}%
[2023/01/20 v0.2 LaTeX file (page design calculations)]
%%


%% PAGE DESIGN CALCULATIONS
% -----------------------------------------------------------------------------


%% MARGINS
% Minimum P.O.D. margins are usually 0.5in/13mm top, outside, bottom,
% plus 0.125in/3mm inside. Novelette does not enforce these, but instead
% enforces much smaller values, just in case you are not using P.O.D.
\def\nvt@process@margins{
  \nvt@oktrue
  \ifdimcomp{\nvt@mtop}{>}{0pt}{ % User set values.
    \ifdimcomp{\nvt@mtop}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mtop}{>}{.25\nvt@trimh}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mout}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mout}{>}{.25\nvt@trimw}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mbot}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mbot}{>}{.25\nvt@trimh}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mins}{<}{0pt}{\nvt@okfalse}{}
    \ifdimcomp{\nvt@mins}{>}{.25\nvt@trimw}{\nvt@okfalse}{}
  }{}
  \ifnvt@ok\else
    \nvt@errMOOR % Margins out of range.
    \global\deflength\nvt@mtop{0pt} % Reset.
  \fi
  \ifdimcomp{\nvt@mtop}{=}{0pt}{ % Unset or reset.
    \FPsub{\nvt@temp@w}{\strip@pt\nvt@trimw}{398} % 398pt is 5.5in.
    \FPifgt{\nvt@temp@w}{0}
      \FPmul{\nvt@temp@d}{\nvt@temp@w}{.2}
    \else
      \def\nvt@temp@d{0}
    \fi
    \IfSubStr*{\log@trimsize}{mm}{ % Using Metric mm units.
      \FPdiv{\nvt@temp@d}{\nvt@temp@d}{2.845} % 2.845pt/mm.
      \FPadd{\nvt@temp@n}{\nvt@temp@d}{13}
      \FPround{\nvt@temp@n}{\nvt@temp@n}{2}
      \FPclip{\nvt@temp@n}{\nvt@temp@n}
      \global\deflength\nvt@mtop{\nvt@temp@n mm}
      \global\deflength\nvt@mout{\nvt@temp@n mm}
      \global\deflength\nvt@mbot{\nvt@temp@n mm}
      \FPadd{\nvt@temp@d}{\nvt@temp@n}{3}
      \FPclip{\nvt@temp@d}{\nvt@temp@d}
      \global\deflength\nvt@mins{\nvt@temp@d mm}
      \global\deflength\nvt@spinew{3mm}
      \xdef\log@margins{\string\margins{top=\nvt@temp@n mm,outside=\nvt@temp@n mm,%
        bottom=\nvt@temp@n mm,inside=\nvt@temp@d mm}}
    }{ % Something else, so use in.
      \FPdiv{\nvt@temp@d}{\nvt@temp@d}{72.27} % 72.27pt/in.
      \FPadd{\nvt@temp@n}{\nvt@temp@d}{.5}
      \FPround{\nvt@temp@n}{\nvt@temp@n}{3}
      \FPclip{\nvt@temp@n}{\nvt@temp@n}
      \global\deflength\nvt@mtop{\nvt@temp@n in}
      \global\deflength\nvt@mout{\nvt@temp@n in}
      \global\deflength\nvt@mbot{\nvt@temp@n in}
      \FPadd{\nvt@temp@d}{\nvt@temp@n}{.125}
      \FPclip{\nvt@temp@d}{\nvt@temp@d}
      \global\deflength\nvt@mins{\nvt@temp@d in}
      \global\deflength\nvt@spinew{.125in}
      \xdef\log@margins{\string\margins{top=\nvt@temp@n in,outside=\nvt@temp@n in,%
        bottom=\nvt@temp@n in,inside=\nvt@temp@d in}}
    }
  }{}
  \global\deflength\nvt@totalh{\nvt@trimh-\nvt@mtop-\nvt@mbot}
}
%%


%% EMWIDTH, GAPS, STYLE, TYPESIZE
\def\nvt@process@design{
  \FPsub{\nvt@temp@n}{\strip@pt\nvt@trimw}{\strip@pt\nvt@mout}
  \FPsub{\nvt@temp@w}{\nvt@temp@n}{\strip@pt\nvt@mins}
  \ifdefined\nvt@textchars\else\gdef\nvt@textchars{62}\fi
  \FPdiv{\nvt@temp@n}{\nvt@temp@w}{\nvt@textchars}
  \FPdiv{\nvt@temp@n}{\nvt@temp@n}{.45} % Average character width 0.45em.
  \FPround{\nvt@temp@n}{\nvt@temp@n}{3}
  \FPclip{\nvt@temp@n}{\nvt@temp@n}
  \global\deflength\nvt@typesize{\nvt@temp@n pt}
  \global\deflength\nvt@spad{0.08\nvt@typesize} % Just a tiny amount.
  \global\deflength\textwidth{\nvt@trimw-\nvt@mout-\nvt@mins-2\nvt@spad}
  \ifdefined\nvt@headgap
    \ifdefined\nvt@footgap\else
      \gdef\nvt@footgap{\nvt@headgap}
    \fi
  \fi
  \ifdefined\nvt@footgap
    \ifdefined\nvt@headgap\else
      \gdef\nvt@headgap{\nvt@footgap}
    \fi
  \fi
  \ifdefined\nvt@headgap\else
    \ifdefined\nvt@footgap\else
      \gdef\nvt@headgap{0.5}
      \gdef\nvt@footgap{0.5}
    \fi
  \fi
  \ifdefined\nvt@hfstyle\else
    \ifdimcomp{\nvt@totalh}{<}{6.8in}{%
      \gdef\nvt@hfstyle{1} % Only footer.
    }{%
      \ifdimcomp{\nvt@totalh}{<}{7.2in}{%
        \gdef\nvt@hfstyle{3} % Only header.
      }{\gdef\nvt@hfstyle{2}} % Both.
    }
  \fi
  \FPiflt{\nvt@hfstyle}{4}\global\nvt@footertrue\fi
  \FPifgt{\nvt@hfstyle}{1}\global\nvt@headertrue\fi
  \FPifeq{\nvt@hfstyle}{0}\global\nvt@footerfalse\fi
  \ifnvt@pnital
    \gdef\pagenumber{\textit{\thepage}}
  \else
    \gdef\pagenumber{\thepage}
  \fi
  \global\deflength\oddsidemargin{\nvt@mins+\nvt@spad+0.5\pagewidth-0.5\nvt@trimw-1in}
  \global\deflength\evensidemargin{\nvt@mout+\nvt@spad+0.5\pagewidth-0.5\nvt@trimw-1in}
}
%%


%% CALCULATE LEADING, LINES PER PAGE (four cases, depending on header/footer)
\def\nvt@calculate@leading{
  \nvt@start@calc
  \ifnvt@header
    \ifnvt@footer\nvt@calculate@leading@both\else\nvt@calculate@leading@head\fi
  \else
    \ifnvt@footer\nvt@calculate@leading@foot\else\nvt@nvtcalculate@leading@none\fi
  \fi
  \nvt@finish@calc
  \nvt@check@leading
}
%%
\def\nvt@start@calc{
  \global\deflength\topmargin{\nvt@mtop+0.5\pageheight-0.5\nvt@trimh-1in}
  \global\deflength\nvtadj@totalh{\nvt@totalh-\nvt@ascn-\nvt@dscn}
}
%%
\def\nvt@calculate@leading@none{ % No header or footer.
  \ifdefined\nvt@lpp\else
    \FPmul{\nvt@temp@n}{\strip@pt\nvt@typesize}{1.3} % A mid-range leading.
    \FPdiv{\nvt@temp@lpp}{\strip@pt\nvtadj@totalh}{\nvt@temp@n}
    \FPtrunc{\nvt@temp@lpp}{\nvt@temp@lpp}{0}
    \xdef\nvt@lpp{\nvt@temp@lpp}
  \fi
  \FPsub{\adj@lpp}{\nvt@lpp}{1}
  \FPdiv{\nvt@temp@leading}{\strip@pt\nvtadj@totalh}{\adj@lpp}
  \FPtrunc{\nvt@temp@leading}{\nvt@temp@leading}{3}
  \global\deflength\nvt@leading{\nvt@temp@leading pt}
  \global\deflength\footskip{0pt}
}
%%
\def\nvt@calculate@leading@head{ % Only header.
  \ifdefined\nvt@lpp\else % User did not set lines.
    \FPmul{\nvt@temp@n}{\strip@pt\nvt@typesize}{1.3}
    \FPdiv{\nvt@temp@lpp}{\strip@pt\nvtadj@totalh}{\nvt@temp@n}
    \FPsub{\nvt@temp@lpp}{\nvt@temp@lpp}{1} % Header.
    \FPsub{\nvt@temp@lpp}{\nvt@temp@lpp}{\nvt@headgap} % Header gap.
    \FPtrunc{\nvt@temp@lpp}{\nvt@temp@lpp}{0}
    \xdef\nvt@lpp{\nvt@temp@lpp}
  \fi
  \FPadd{\adj@lpp}{\nvt@lpp}{\nvt@headgap}
  \FPdiv{\nvt@temp@leading}{\strip@pt\nvtadj@totalh}{\adj@lpp}
  \FPtrunc{\nvt@temp@leading}{\nvt@temp@leading}{3}
  \global\deflength\nvt@leading{\nvt@temp@leading pt}
  \global\deflength\footskip{0pt}
  \global\deflength\headheight{\nvt@leading}
  \global\deflength\headsep{\nvt@headgap\nvt@leading}
}
%%
\def\nvt@calculate@leading@foot{ % Only footer.
  \ifdefined\nvt@lpp\else % User did not set lines.
    \FPmul{\nvt@temp@n}{\strip@pt\nvt@typesize}{1.3}
    \FPdiv{\nvt@temp@lpp}{\strip@pt\nvtadj@totalh}{\nvt@temp@n}
    \FPsub{\nvt@temp@lpp}{\nvt@temp@lpp}{\nvt@footgap} % Footer gap.
    \FPsub{\nvt@temp@lpp}{\nvt@temp@lpp}{1} % Footer.
    \FPtrunc{\nvt@temp@lpp}{\nvt@temp@lpp}{0}
    \xdef\nvt@lpp{\nvt@temp@lpp}
  \fi
  \FPadd{\adj@lpp}{\nvt@lpp}{\nvt@footgap}
  \FPdiv{\nvt@temp@leading}{\strip@pt\nvtadj@totalh}{\adj@lpp}
  \FPtrunc{\nvt@temp@leading}{\nvt@temp@leading}{3}
  \global\deflength\nvt@leading{\nvt@temp@leading pt}
  \global\deflength\footskip{\nvt@footgap\nvt@leading+\nvt@leading}
}
\def\nvt@calculate@leading@both{ % Header and footer.
  \ifdefined\nvt@lpp\else
    \FPmul{\nvt@temp@n}{\strip@pt\nvt@typesize}{1.3}
    \FPdiv{\nvt@temp@lpp}{\strip@pt\nvtadj@totalh}{\nvt@temp@n}
    \FPsub{\nvt@temp@lpp}{\nvt@temp@lpp}{2} % Header and footer
    \FPsub{\nvt@temp@lpp}{\nvt@temp@lpp}{\nvt@headgap} % Header gap.
    \FPsub{\nvt@temp@lpp}{\nvt@temp@lpp}{\nvt@footgap} % Footer gap.
    \FPtrunc{\nvt@temp@lpp}{\nvt@temp@lpp}{0}
    \xdef\nvt@lpp{\nvt@temp@lpp}
  \fi
  \FPadd{\adj@lpp}{\nvt@lpp}{1}
  \FPadd{\adj@lpp}{\adj@lpp}{\nvt@headgap}
  \FPadd{\adj@lpp}{\adj@lpp}{\nvt@footgap}
  \FPdiv{\nvt@temp@leading}{\strip@pt\nvtadj@totalh}{\adj@lpp}
  \FPtrunc{\nvt@temp@leading}{\nvt@temp@leading}{3}
  \global\deflength\nvt@leading{\nvt@temp@leading pt}
  \global\deflength\headheight{\nvt@leading}
  \global\deflength\headsep{\nvt@headgap\nvt@leading}
  \global\deflength\footskip{\nvt@footgap\nvt@leading}
}
%%
\def\nvt@finish@calc{
  \global\deflength\topskip{\nvt@ascn}
  \global\deflength\textheight{\nvt@lpp\nvt@leading-\nvt@leading+\nvt@ascn}
  \global\deflength\baselineskip{\nvt@leading}
  \xdef\log@design{%
    \string\design{chars=\nvt@textchars,lines=\nvt@lpp,%
    headgap=\nvt@headgap,footgap=\nvt@footgap,%
    style=\nvt@hfstyle\ifnvt@pnital i\fi}%
  }%
}
%%
\def\nvt@check@leading{
  \FPadd{\nvt@temp@d}{\strip@pt\nvt@ascn}{\strip@pt\nvt@dscn}
  \FPdiv{\nvt@temp@n}{\strip@pt\nvt@leading}{\nvt@temp@d}
  \FPiflt{\nvt@temp@n}{1}\nvt@errTMLPP\fi % Too many lines per page.
}
%%


%% RENEW NORMALSIZE
\def\nvt@renew@normalsize{
  \renewcommand\normalsize{\@setfontsize\normalsize{\nvt@typesize}{\nvt@leading}}
  \normalsize
  \let\@normalsize\normalsize\relax % Hack for fancyhdr.
  \global\deflength\normalindent{1.5\nvt@typesize}
  \global\deflength\footnotesep{0.8\nvt@leading}
  \DeclareRobustCommand\@footnotesize{% For actual footnotes.
    \@setfontsize\@footnotesize{.92\nvt@typesize}{.92\nvt@leading}%
  }
  \let\tiny\normalsize\relax
  \let\scriptsize\normalsize\relax
  \let\footnotesize\normalsize\relax % See \@footnotesize.
  \let\small\normalsize\relax
  \let\large\normalsize\relax
  \let\Large\normalsize\relax
  \let\LARGE\normalsize\relax
  \let\huge\normalsize\relax
  \let\Huge\normalsize\relax
  \let\HUGE\normalsize\relax
}
%%


%%
\endinput
%%
%% End of file `novelette-design.sty'.
